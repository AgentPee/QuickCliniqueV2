@model QuickClinique.Models.Student
@{
    ViewData["Title"] = "Patient Details";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/precord.css" asp-append-version="true" />
}

<div class="patient-details-container">
    @Html.AntiForgeryToken()
    <a href="@Url.Action("Index")" class="btn-back">
        <i class="fas fa-arrow-left"></i> Back to Patient List
    </a>

    <div class="patient-info-card">
        <div class="patient-info-header">
            <div class="patient-avatar">
                @(Model.FirstName.Substring(0, 1).ToUpper())@(Model.LastName.Substring(0, 1).ToUpper())
            </div>
            <div class="patient-header-info">
                <h2>@Model.FirstName @Model.LastName</h2>
                <p><i class="fas fa-id-card"></i> ID: @Model.Idnumber</p>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Email Address</div>
                    <div class="info-value">@Model.Email</div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Phone Number</div>
                    <div class="info-value">@Model.PhoneNumber</div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Email Verification</div>
                    <div class="info-value">
                        @if (Model.IsEmailVerified)
                        {
                            <span class="text-success-custom"><i class="fas fa-check-circle"></i> Verified</span>
                        }
                        else
                        {
                            <span class="text-danger-custom"><i class="fas fa-times-circle"></i> Not Verified</span>
                        }
                    </div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-toggle-on"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Account Status</div>
                    <div class="info-value">
                        @if (Model.IsActive)
                        {
                            <span class="badge badge-success">
                                <i class="fas fa-check-circle"></i> Active
                            </span>
                        }
                        else
                        {
                            <span class="badge badge-danger">
                                <i class="fas fa-ban"></i> Inactive
                            </span>
                        }
                        <button onclick="showToggleModal(@Model.StudentId, '@Model.FirstName @Model.LastName', @Model.IsActive.ToString().ToLower())" 
                                class="btn-action @(Model.IsActive ? "btn-delete" : "status-button-activate ml-10")">
                            <i class="fas fa-@(Model.IsActive ? "ban" : "check")"></i> @(Model.IsActive ? "Deactivate" : "Activate")
                        </button>
                    </div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Total Appointments</div>
                    <div class="info-value">@Model.Appointments.Count</div>
                </div>
            </div>
        </div>
    </div>

    @{
        // Parse ID images (comma-separated: front, back)
        string? idFrontImage = null;
        string? idBackImage = null;
        if (!string.IsNullOrEmpty(Model.Image))
        {
            var imagePaths = Model.Image.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            if (imagePaths.Length > 0)
            {
                idFrontImage = imagePaths[0];
            }
            if (imagePaths.Length > 1)
            {
                idBackImage = imagePaths[1];
            }
        }
    }

    <!-- ID and Insurance Documents Section -->
    <div class="documents-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="fas fa-id-card"></i>
                Identification & Insurance Documents
            </h3>
        </div>

        <div class="documents-grid">
            <!-- ID Front -->
            <div class="document-card">
                <div class="document-header">
                    <h4 class="document-title">
                        <i class="fas fa-id-card"></i> ID Front
                    </h4>
                </div>
                <div class="document-content">
                    @if (!string.IsNullOrEmpty(idFrontImage))
                    {
                        <div class="insurance-receipt-container">
                            <div class="current-file">
                                <p><strong>Current ID Front:</strong></p>
                                <img src="@idFrontImage" alt="ID Front" class="preview-image" />
                                <a href="@idFrontImage" target="_blank" class="btn btn-sm btn-secondary mt-2">
                                    <i class="fas fa-external-link-alt"></i> View Full Size
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="document-placeholder">
                            <i class="fas fa-image"></i>
                            <p>No ID Front image available</p>
                        </div>
                    }
                </div>
            </div>

            <!-- ID Back -->
            <div class="document-card">
                <div class="document-header">
                    <h4 class="document-title">
                        <i class="fas fa-id-card"></i> ID Back
                    </h4>
                </div>
                <div class="document-content">
                    @if (!string.IsNullOrEmpty(idBackImage))
                    {
                        <div class="insurance-receipt-container">
                            <div class="current-file">
                                <p><strong>Current ID Back:</strong></p>
                                <img src="@idBackImage" alt="ID Back" class="preview-image" />
                                <a href="@idBackImage" target="_blank" class="btn btn-sm btn-secondary mt-2">
                                    <i class="fas fa-external-link-alt"></i> View Full Size
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="document-placeholder">
                            <i class="fas fa-image"></i>
                            <p>No ID Back image available</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Insurance Receipt -->
            <div class="document-card">
                <div class="document-header">
                    <h4 class="document-title">
                        <i class="fas fa-file-medical"></i> Insurance Receipt
                    </h4>
                </div>
                <div class="document-content">
                    @if (!string.IsNullOrEmpty(Model.InsuranceReceipt))
                    {
                        <div class="insurance-receipt-container">
                            <div class="current-file">
                                <p><strong>Current Receipt:</strong></p>
                                <img src="@Model.InsuranceReceipt" alt="Insurance Receipt" class="preview-image" />
                                <a href="@Model.InsuranceReceipt" target="_blank" class="btn btn-sm btn-secondary mt-2">
                                    <i class="fas fa-external-link-alt"></i> View Full Size
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="document-placeholder">
                            <i class="fas fa-file-medical"></i>
                            <p>No insurance receipt available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="appointments-section">
        <div class="section-header">
            <h3 class="section-title">
                <i class="fas fa-history"></i>
                Appointment History
            </h3>
        </div>

        @if (Model.Appointments != null && Model.Appointments.Any())
        {
            <div class="appointments-list">
                @foreach (var appointment in Model.Appointments)
                {
                    <div class="appointment-item">
                        <div class="appointment-header-row">
                            <div class="appointment-date-time">
                                <div class="date-badge">
                                    <i class="fas fa-calendar"></i>
                                    <span>@appointment.Schedule.Date.ToString("MMMM dd, yyyy")</span>
                                </div>
                                <div class="time-badge">
                                    <i class="fas fa-clock"></i>
                                    <span>@appointment.Schedule.StartTime.ToString("hh:mm tt") - @appointment.Schedule.EndTime.ToString("hh:mm tt")</span>
                                </div>
                            </div>
                            <div>
                                @{
                                    var statusClass = "status-" + appointment.AppointmentStatus.ToLower();
                                }
                                <span class="status-badge @statusClass">@appointment.AppointmentStatus</span>
                            </div>
                        </div>

                        <div class="appointment-details-row">
                            <div class="detail-row">
                                <i class="fas fa-notes-medical"></i>
                                <strong>Reason for Visit:</strong>
                                <span>@appointment.ReasonForVisit</span>
                            </div>

                            @if (!string.IsNullOrEmpty(appointment.Symptoms))
                            {
                                <div class="detail-row">
                                    <i class="fas fa-heartbeat"></i>
                                    <strong>Symptoms:</strong>
                                    <span>@appointment.Symptoms</span>
                                </div>
                            }

                            <div class="detail-row">
                                <i class="fas fa-hashtag"></i>
                                <strong>Queue Number:</strong>
                                <span>@appointment.QueueNumber</span>
                            </div>

                            <div class="detail-row">
                                <i class="fas fa-calendar-day"></i>
                                <strong>Date Booked:</strong>
                                <span>@appointment.DateBooked.ToString("MMMM dd, yyyy")</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-appointments">
                <i class="fas fa-calendar-times"></i>
                <p>This patient has no appointment history yet.</p>
            </div>
        }
    </div>

    @if (Model.Precords != null && Model.Precords.Any())
    {
        <div class="medical-records-section medical-records-section-mt">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-file-medical"></i>
                    Medical Records
                </h3>
            </div>

            <div class="medical-records-list">
                @foreach (var record in Model.Precords.OrderByDescending(r => r.RecordId))
                {
                    <div class="medical-record-item medical-record-item-style">
                        <div class="medical-record-header">
                            <h4 class="medical-record-title">
                                <i class="fas fa-file-medical-alt"></i> Record #@record.RecordId
                            </h4>
                          
                        </div>
                        
                        <div class="medical-record-grid">
                            <div>
                                <strong><i class="fas fa-stethoscope"></i> Diagnosis:</strong>
                                <p class="medical-record-text">@record.Diagnosis</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-pills"></i> Medications:</strong>
                                <p class="medical-record-text">@record.Medications</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-exclamation-triangle"></i> Allergies:</strong>
                                <p class="medical-record-text">@record.Allergies</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-user"></i> Age:</strong>
                                <p class="medical-record-text">@record.Age years</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-venus-mars"></i> Gender:</strong>
                                <p class="medical-record-text">@record.Gender</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-weight"></i> BMI:</strong>
                                <p class="medical-record-text">@record.Bmi</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-heart"></i> Pulse Rate:</strong>
                                <p class="medical-record-text">@(record.PulseRate.HasValue ? record.PulseRate.Value + " bpm" : "N/A")</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-tachometer-alt"></i> Blood Pressure:</strong>
                                <p class="medical-record-text">@(!string.IsNullOrEmpty(record.BloodPressure) ? record.BloodPressure : "N/A")</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-thermometer-half"></i> Temperature:</strong>
                                <p class="medical-record-text">@(record.Temperature.HasValue ? record.Temperature.Value.ToString("F1") + "Â°C" : "N/A")</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-lungs"></i> Respiratory Rate:</strong>
                                <p class="medical-record-text">@(record.RespiratoryRate.HasValue ? record.RespiratoryRate.Value + " breaths/min" : "N/A")</p>
                            </div>
                            <div>
                                <strong><i class="fas fa-wind"></i> Oxygen Saturation:</strong>
                                <p class="medical-record-text">@(record.OxygenSaturation.HasValue ? record.OxygenSaturation.Value + "%" : "N/A")</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="medical-records-section medical-records-section-mt">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-file-medical"></i>
                    Medical Records
                </h3>
            </div>
            <div class="no-appointments no-appointments-style">
                <i class="fas fa-file-medical no-appointments-icon"></i>
                <p class="no-appointments-text">No medical records found for this patient.</p>
           
            </div>
        </div>
    }

    <div class="action-buttons-container">
        <button onclick="showEditModal(@Model.StudentId)" class="btn-action btn-edit action-button-style">
            <i class="fas fa-edit"></i> Edit Patient Info
        </button>
    
        <a href="@Url.Action("Index")" class="btn-back btn-back-custom">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

<!-- Image View Modal -->
<div id="imageModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-image"></i> <span id="imageModalTitle">Image</span></h2>
            <button class="modal-close" onclick="closeModal('imageModal')">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <img id="modalImage" src="" alt="Document Image" style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);" />
        </div>
    </div>
</div>

<!-- Toggle Active Modal (same as in Index.cshtml) -->
<div id="toggleModal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header" id="toggleModalHeader">
            <h2><i class="fas fa-exclamation-triangle"></i> <span id="toggleModalTitle">Confirm Action</span></h2>
            <button class="modal-close" onclick="closeModal('toggleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="toggleMessage" class="toggle-message-text"></p>
            <div class="toggle-modal-buttons">
                <button onclick="closeModal('toggleModal')" class="btn-action btn-view toggle-modal-button">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="confirmToggle()" class="btn-action toggle-modal-button" id="toggleConfirmButton">
                    <i class="fas fa-check"></i> <span id="toggleConfirmText">Confirm</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentToggleId = null;
        let currentToggleIsActive = null;

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Toggle Active Modal
        function showToggleModal(patientId, patientName, isCurrentlyActive) {
            currentToggleId = patientId;
            currentToggleIsActive = isCurrentlyActive;
            
            const toggleModal = document.getElementById('toggleModal');
            const toggleMessage = document.getElementById('toggleMessage');
            const toggleTitle = document.getElementById('toggleModalTitle');
            const toggleHeader = document.getElementById('toggleModalHeader');
            const toggleConfirmButton = document.getElementById('toggleConfirmButton');
            const toggleConfirmText = document.getElementById('toggleConfirmText');
            
            if (isCurrentlyActive) {
                // Deactivating
                toggleTitle.textContent = 'Confirm Deactivate';
                toggleMessage.textContent = `Are you sure you want to deactivate patient "${patientName}"? They will no longer be able to login to the system.`;
                toggleHeader.className = 'modal-header modal-header-danger';
                toggleConfirmButton.className = 'btn-action btn-delete';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmText.innerHTML = '<i class="fas fa-ban"></i> Deactivate';
            } else {
                // Activating
                toggleTitle.textContent = 'Confirm Activate';
                toggleMessage.textContent = `Are you sure you want to activate patient "${patientName}"? They will be able to login to the system again.`;
                toggleHeader.className = 'modal-header';
                toggleHeader.style.backgroundColor = '#28a745';
                toggleHeader.style.color = 'white';
                toggleConfirmButton.className = 'btn-action';
                toggleConfirmButton.style.backgroundColor = '#28a745';
                toggleConfirmButton.style.color = 'white';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmText.innerHTML = '<i class="fas fa-check"></i> Activate';
            }
            
            openModal('toggleModal');
        }

        async function confirmToggle() {
            if (!currentToggleId) return;

            const toggleModal = document.getElementById('toggleModal');
            const modalBody = toggleModal.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Updating...</div>';

            try {
                const formData = new FormData();
                
                // Get or create anti-forgery token
                let token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (!token) {
                    // Create a temporary form to get the token
                    const tempForm = document.createElement('form');
                    tempForm.innerHTML = '@Html.AntiForgeryToken()';
                    token = tempForm.querySelector('input[name="__RequestVerificationToken"]');
                }
                
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }

                const response = await fetch(`/Precord/ToggleActivePatient/${currentToggleId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message || 'Patient status updated successfully!', 'success');
                    closeModal('toggleModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error(result.message || 'Failed to update patient status');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating patient status. Please try again.', 'error');
                closeModal('toggleModal');
            }
        }

        // Edit Modal (for editing patient info)
        async function showEditModal(patientId) {
            // This will be handled by the modal from Index.cshtml if loaded via AJAX
            // For now, redirect to edit page or use the same modal approach
            window.location.href = `/Precord/EditPatient/${patientId}`;
        }

        // Image Modal Functions
        function openImageModal(imageSrc, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('imageModalTitle');
            
            modalImage.src = imageSrc;
            modalTitle.textContent = title;
            openModal('imageModal');
        }

        // Notification System
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <div>${message}</div>
            `;
            notification.style.maxWidth = '500px';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    </script>
}

