@model IEnumerable<QuickClinique.Models.Student>
@{
    ViewData["Title"] = "Patient Management";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/precord.css" asp-append-version="true" />
}

<div class="patients-container">
    @Html.AntiForgeryToken()
    
    <div class="page-header">
        <h1>
            <i class="fas fa-users"></i>
            Patient Management
        </h1>
    </div>

    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name, ID number, email, or phone..." />
            <button onclick="searchPatients()">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="patients-table-container">
            <table class="patients-table">
                <thead>
                    <tr>
                 
                        <th><i class="fas fa-id-card"></i> ID Number</th>
                        <th><i class="fas fa-user"></i> Name</th>
                        <th><i class="fas fa-envelope"></i> Email</th>
                        <th><i class="fas fa-phone"></i> Phone</th>
                        <th><i class="fas fa-info-circle"></i> Status</th>
                        <th><i class="fas fa-cog"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="patientsTableBody">
                    @foreach (var patient in Model)
                    {
                        <tr data-patient-id="@patient.StudentId" data-search="@patient.Idnumber @patient.FirstName @patient.LastName @patient.Email @patient.PhoneNumber">
                            <td>
                                <span class="patient-field">
                                    <i class="fas fa-id-card"></i> @patient.Idnumber
                                </span>
                            </td>
                            <td>
                                <span class="patient-name">
                                    <i class="fas fa-user"></i> @patient.FirstName @patient.LastName
                                </span>
                            </td>
                            <td>
                                <span class="patient-field">
                                    <i class="fas fa-envelope"></i> @patient.Email
                                </span>
                            </td>
                            <td>
                                <span class="patient-field">
                                    <i class="fas fa-phone"></i> @patient.PhoneNumber
                                </span>
                            </td>
                            <td>
                                <div class="flex-align-center">
                                    @if (patient.IsActive)
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Active
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">
                                            <i class="fas fa-ban"></i> Inactive
                                        </span>
                                    }
                                    @if (patient.IsActive)
                                    {
                                        <button onclick="showToggleModal(@patient.StudentId, '@patient.FirstName @patient.LastName', true)" class="btn-action btn-delete btn-sm-custom">
                                            <i class="fas fa-ban"></i> Deactivate
                                        </button>
                                    }
                                    else
                                    {
                                        <button onclick="showToggleModal(@patient.StudentId, '@patient.FirstName @patient.LastName', false)" class="btn-action status-button-activate">
                                            <i class="fas fa-check"></i> Activate
                                        </button>
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick="showDetailsModal(@patient.StudentId)" class="btn-action btn-view">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                    <button onclick="showEditModal(@patient.StudentId)" class="btn-action btn-edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="fas fa-users"></i>
            <h3>No Patients Registered</h3>
            <p>There are currently no patients registered in the system.</p>
        </div>
    }
</div>

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-user-circle"></i> Patient Details</h2>
            <button class="modal-close" onclick="closeModal('detailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailsModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Patient Information</h2>
            <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
        </div>
        <div class="modal-body" id="editModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        </div>
    </div>
</div>

<!-- Toggle Active Modal -->
<div id="toggleModal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header" id="toggleModalHeader">
            <h2><i class="fas fa-exclamation-triangle"></i> <span id="toggleModalTitle">Confirm Action</span></h2>
            <button class="modal-close" onclick="closeModal('toggleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="toggleMessage" class="toggle-message-text"></p>
            <div class="toggle-modal-buttons">
                <button onclick="closeModal('toggleModal')" class="btn-action btn-view toggle-modal-button">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="confirmToggle()" class="btn-action toggle-modal-button" id="toggleConfirmButton">
                    <i class="fas fa-check"></i> <span id="toggleConfirmText">Confirm</span>
                </button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_EmergencyPolling")

@section Scripts {
    <script>
        let currentToggleId = null;
        let currentToggleIsActive = null;

        function searchPatients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#patientsTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const searchData = row.getAttribute('data-search').toLowerCase();
                if (searchData.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (visibleCount === 0 && searchTerm) {
                showNoResultsMessage();
            } else {
                removeNoResultsMessage();
            }
        }

        function showNoResultsMessage() {
            let existingMessage = document.getElementById('noResultsMessage');
            if (!existingMessage) {
                const tbody = document.getElementById('patientsTableBody');
                const row = tbody.insertRow(0);
                row.id = 'noResultsMessage';
                const cell = row.insertCell(0);
                cell.colSpan = 6;
                cell.style.textAlign = 'center';
                cell.style.padding = '2rem';
                cell.style.color = '#718096';
                cell.innerHTML = '<i class="fas fa-search icon-2x d-block mb-1 text-muted"></i><p class="m-0">No patients match your search criteria.</p>';
            }
        }

        function removeNoResultsMessage() {
            const message = document.getElementById('noResultsMessage');
            if (message) {
                message.remove();
            }
        }

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPatients();
            }
        });

        document.getElementById('searchInput').addEventListener('input', searchPatients);

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Details Modal
        async function showDetailsModal(patientId) {
            openModal('detailsModal');
            const modalBody = document.getElementById('detailsModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const response = await fetch(`/Precord/Details/${patientId}`);
                if (!response.ok) throw new Error('Failed to load patient details');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.patient-details-container');
                
                if (content) {
                    // Remove back button
                    const backBtn = content.querySelector('.btn-back');
                    if (backBtn) backBtn.remove();
                    
                    // Remove bottom buttons
                    const bottomButtons = content.querySelector('div[style*="margin-top: 2rem"]');
                    if (bottomButtons) bottomButtons.remove();
                    
                    modalBody.innerHTML = content.innerHTML;
                    
                    // Extract and execute scripts from the loaded content
                    const scripts = doc.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        document.body.appendChild(newScript);
                    });
                    
                    // Ensure upload file functions are available after content loads
                    // Wait a bit for modal HTML to be available
                    setTimeout(() => {
                        ensureUploadFileFunctions(modalBody);
                    }, 100);
                    
                    // Initialize collapsible sections after content is loaded
                    // Wait a bit for scripts to execute
                    setTimeout(() => {
                        if (typeof window.initCollapsibles === 'function') {
                            window.initCollapsibles();
                        } else {
                            // Fallback: manually initialize if function not available
                            initializeModalCollapsibles(modalBody);
                        }
                    }, 200);
                    
                    // Fix image paths - convert relative paths to absolute URLs
                    const images = modalBody.querySelectorAll('img[src]');
                    images.forEach(img => {
                        const src = img.getAttribute('src');
                        if (src && !src.startsWith('http') && !src.startsWith('//') && !src.startsWith('data:')) {
                            // If it's a relative path, make it absolute
                            if (src.startsWith('/')) {
                                // Already absolute from root, keep as is
                                img.src = src;
                            } else if (src.startsWith('~/')) {
                                // Convert ~/ to root
                                img.src = src.replace('~/', '/');
                            } else {
                                // Relative path, make absolute from root
                                img.src = '/' + src;
                            }
                        }
                    });
                    
                    // Fix anchor hrefs for image links
                    const imageLinks = modalBody.querySelectorAll('a[href]');
                    imageLinks.forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#')) {
                            if (href.startsWith('/')) {
                                link.href = href;
                            } else if (href.startsWith('~/')) {
                                link.href = href.replace('~/', '/');
                            } else {
                                link.href = '/' + href;
                            }
                        }
                    });
                } else {
                    modalBody.innerHTML = '<p class="modal-error-text">Failed to load patient details.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading patient details. Please try again.</p>';
            }
        }

        // Edit Modal
        async function showEditModal(patientId) {
            openModal('editModal');
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const response = await fetch(`/Precord/EditPatient/${patientId}`);
                if (!response.ok) throw new Error('Failed to load patient data');
                
                const html = await response.text();
                modalBody.innerHTML = html;
                
                // Setup form submission
                const form = document.getElementById('editPatientForm');
                if (form) {
                    form.addEventListener('submit', (e) => submitEditForm(e, patientId));
                } else {
                    modalBody.innerHTML = '<p class="modal-error-text">Failed to load edit form.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading edit form. Please try again.</p>';
            }
        }

        async function submitEditForm(event, patientId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalHtml = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`/Precord/EditPatient/${patientId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message || 'Patient information updated successfully!', 'success');
                    closeModal('editModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    // Display validation errors
                    let errorMessage = result.message || 'Failed to update patient information.';
                    
                    if (result.errors) {
                        // Display specific field errors
                        const errorList = Object.entries(result.errors)
                            .map(([field, errors]) => `${field}: ${errors.join(', ')}`)
                            .join('<br>');
                        errorMessage += '<br><small>' + errorList + '</small>';
                    }
                    
                    showNotification(errorMessage, 'error');
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating patient information. Please try again.', 'error');
                submitBtn.innerHTML = originalHtml;
                submitBtn.disabled = false;
            }
        }

        // Toggle Active Modal
        function showToggleModal(patientId, patientName, isCurrentlyActive) {
            currentToggleId = patientId;
            currentToggleIsActive = isCurrentlyActive;
            
            const toggleModal = document.getElementById('toggleModal');
            const toggleMessage = document.getElementById('toggleMessage');
            const toggleTitle = document.getElementById('toggleModalTitle');
            const toggleHeader = document.getElementById('toggleModalHeader');
            const toggleConfirmButton = document.getElementById('toggleConfirmButton');
            const toggleConfirmText = document.getElementById('toggleConfirmText');
            
            if (isCurrentlyActive) {
                // Deactivating
                toggleTitle.textContent = 'Confirm Deactivate';
                toggleMessage.textContent = `Are you sure you want to deactivate patient "${patientName}"? They will no longer be able to login to the system.`;
                toggleHeader.className = 'modal-header modal-header-danger';
                toggleConfirmButton.className = 'btn-action btn-delete';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmText.innerHTML = '<i></i> Deactivate';
            } else {
                // Activating
                toggleTitle.textContent = 'Confirm Activate';
                toggleMessage.textContent = `Are you sure you want to activate patient "${patientName}"? They will be able to login to the system again.`;
                toggleHeader.className = 'modal-header';
                toggleHeader.style.backgroundColor = '#28a745';
                toggleHeader.style.color = 'white';
                toggleConfirmButton.className = 'btn-action';
                toggleConfirmButton.style.backgroundColor = '#28a745';
                toggleConfirmButton.style.color = 'white';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmText.innerHTML = '<i></i> Activate';
            }
            
            openModal('toggleModal');
        }

        async function confirmToggle() {
            if (!currentToggleId) return;

            const toggleModal = document.getElementById('toggleModal');
            const modalBody = toggleModal.querySelector('.modal-body');
            const toggleConfirmButton = document.getElementById('toggleConfirmButton');
            const toggleMessage = document.getElementById('toggleMessage');
            const cancelButton = modalBody.querySelector('.toggle-modal-button[onclick*="closeModal"]');
            
            // Store original content
            const originalMessage = toggleMessage.textContent;
            const originalButtonHtml = toggleConfirmButton.innerHTML;
            const originalButtonDisabled = toggleConfirmButton.disabled;
            
            // Show loading state without destroying structure
            toggleMessage.textContent = 'Updating...';
            toggleConfirmButton.disabled = true;
            toggleConfirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            if (cancelButton) cancelButton.disabled = true;

            try {
                const formData = new FormData();
                
                // Get or create anti-forgery token
                let token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (!token) {
                    // Create a temporary form to get the token
                    const tempForm = document.createElement('form');
                    tempForm.innerHTML = '@Html.AntiForgeryToken()';
                    token = tempForm.querySelector('input[name="__RequestVerificationToken"]');
                }
                
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }

                const response = await fetch(`/Precord/ToggleActivePatient/${currentToggleId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message || 'Patient status updated successfully!', 'success');
                    closeModal('toggleModal');
                    
                    // Restore modal content
                    toggleMessage.textContent = originalMessage;
                    toggleConfirmButton.innerHTML = originalButtonHtml;
                    toggleConfirmButton.disabled = originalButtonDisabled;
                    if (cancelButton) cancelButton.disabled = false;
                    
                    // Update UI dynamically without reloading
                    updatePatientStatusUI(currentToggleId, result.isActive);
                } else {
                    throw new Error(result.message || 'Failed to update patient status');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating patient status. Please try again.', 'error');
                
                // Restore modal content
                toggleMessage.textContent = originalMessage;
                toggleConfirmButton.innerHTML = originalButtonHtml;
                toggleConfirmButton.disabled = originalButtonDisabled;
                if (cancelButton) cancelButton.disabled = false;
                
                closeModal('toggleModal');
            }
        }

        // Update patient status UI dynamically
        function updatePatientStatusUI(patientId, isActive) {
            const row = document.querySelector(`tr[data-patient-id="${patientId}"]`);
            if (!row) return;
            
            const statusCell = row.querySelector('td:nth-child(5)'); // Status column
            if (!statusCell) return;
            
            const statusDiv = statusCell.querySelector('.flex-align-center');
            if (!statusDiv) return;
            
            // Get patient name from the row for the button
            const nameCell = row.querySelector('td:nth-child(2)');
            const patientName = nameCell ? nameCell.textContent.trim() : 'Patient';
            
            // Clear existing content
            statusDiv.innerHTML = '';
            
            // Create badge
            const badge = document.createElement('span');
            badge.className = isActive ? 'badge badge-success' : 'badge badge-danger';
            badge.innerHTML = `<i class="fas fa-${isActive ? 'check-circle' : 'ban'}"></i> ${isActive ? 'Active' : 'Inactive'}`;
            statusDiv.appendChild(badge);
            
            // Create button
            const button = document.createElement('button');
            button.className = isActive ? 'btn-action btn-delete btn-sm-custom' : 'btn-action status-button-activate';
            button.innerHTML = `<i class="fas fa-${isActive ? 'ban' : 'check'}"></i> ${isActive ? 'Deactivate' : 'Activate'}`;
            button.addEventListener('click', function() {
                showToggleModal(patientId, patientName, isActive);
            });
            statusDiv.appendChild(button);
        }

        // Notification System
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <div>${message}</div>
            `;
            notification.style.maxWidth = '500px';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Fallback function to initialize collapsibles in modal
        function initializeModalCollapsibles(container) {
            // Toggle Appointment Details
            function toggleAppointmentDetails(header) {
                if (!header) return;
                const appointmentItem = header.closest('.appointment-item');
                if (!appointmentItem) return;
                const detailsRow = appointmentItem.querySelector('.appointment-details-row');
                const chevron = header.querySelector('.appointment-chevron');
                if (!detailsRow) return;
                
                detailsRow.classList.toggle('appointment-details-collapsed');
                if (chevron) {
                    chevron.style.transform = detailsRow.classList.contains('appointment-details-collapsed') 
                        ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            }

            // Toggle Medical Record Details
            function toggleMedicalRecordDetails(header) {
                if (!header) return;
                const recordItem = header.closest('.medical-record-item');
                if (!recordItem) return;
                const recordGrid = recordItem.querySelector('.medical-record-grid');
                const chevron = header.querySelector('.medical-record-chevron');
                if (!recordGrid) return;
                
                recordGrid.classList.toggle('medical-record-details-collapsed');
                if (chevron) {
                    chevron.style.transform = recordGrid.classList.contains('medical-record-details-collapsed') 
                        ? 'rotate(0deg)' : 'rotate(180deg)';
                }
            }

            // Attach event listeners
            container.querySelectorAll('[data-toggle="appointment"]').forEach(header => {
                header.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleAppointmentDetails(this);
                });
            });

            container.querySelectorAll('[data-toggle="medical-record"]').forEach(header => {
                header.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMedicalRecordDetails(this);
                });
            });
        }

        // Ensure upload file functions are available in the modal
        function ensureUploadFileFunctions(modalBody) {
            // Check if upload modal exists in the loaded content
            let uploadModal = modalBody.querySelector('#uploadFileModal');
            
            // If upload modal exists in modal body but not in document, move it to document body
            if (uploadModal && !document.getElementById('uploadFileModal')) {
                // Clone and append to document body so it's accessible globally
                const clonedModal = uploadModal.cloneNode(true);
                document.body.appendChild(clonedModal);
                console.log('Upload modal moved to document body');
            } else if (!uploadModal) {
                // Check if it already exists in document
                uploadModal = document.getElementById('uploadFileModal');
            }
            
            // Define upload file functions if they don't exist
            if (typeof window.showUploadFileModal !== 'function') {
                window.showUploadFileModal = function(patientId) {
                    console.log('showUploadFileModal called with patientId:', patientId);
                    const modal = document.getElementById('uploadFileModal');
                    if (!modal) {
                        console.error('Upload file modal not found');
                        alert('Upload modal not found. Please refresh the page.');
                        return;
                    }
                    
                    const hiddenInput = document.getElementById('uploadPatientId');
                    if (hiddenInput) {
                        hiddenInput.value = patientId;
                    }
                    
                    const form = document.getElementById('uploadFileForm');
                    if (form) {
                        form.reset();
                        if (hiddenInput) {
                            hiddenInput.value = patientId;
                        }
                    }
                    openModal('uploadFileModal');
                };
            }
            
            if (typeof window.uploadMedicalRecordFile !== 'function') {
                window.uploadMedicalRecordFile = async function(patientId) {
                    console.log('uploadMedicalRecordFile called with patientId:', patientId);
                    const form = document.getElementById('uploadFileForm');
                    if (!form) {
                        console.error('Upload form not found');
                        alert('Upload form not found. Please refresh the page.');
                        return;
                    }
                    
                    const fileInput = document.getElementById('fileInput');
                    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                        alert('Please select a file to upload.');
                        fileInput?.focus();
                        return;
                    }

                    const formData = new FormData();
                    let token = form.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        formData.append('__RequestVerificationToken', token.value);
                    }
                    
                    formData.append('patientId', patientId);
                    formData.append('file', fileInput.files[0]);
                    
                    const description = document.getElementById('fileDescription');
                    if (description && description.value) {
                        formData.append('description', description.value.trim());
                    }

                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                    }

                    try {
                        const response = await fetch('/Precord/UploadMedicalRecordFile', {
                            method: 'POST',
                            body: formData
                        });

                        let result;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            result = await response.json();
                        } else {
                            const text = await response.text();
                            try {
                                result = JSON.parse(text);
                            } catch {
                                throw new Error(text || 'Failed to upload file');
                            }
                        }

                        if (result.success) {
                            alert('File uploaded successfully!');
                            closeModal('uploadFileModal');
                            form.reset();
                            setTimeout(() => {
                                // Reload the details modal content
                                const patientIdInput = document.getElementById('uploadPatientId');
                                const currentPatientId = patientIdInput ? patientIdInput.value : patientId;
                                if (currentPatientId) {
                                    showDetailsModal(parseInt(currentPatientId));
                                }
                            }, 500);
                        } else {
                            throw new Error(result.message || 'Failed to upload file');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert(error.message || 'Error uploading file. Please try again.');
                    } finally {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-upload"></i> Upload';
                        }
                    }
                };
            }
            
            if (typeof window.deleteMedicalRecordFile !== 'function') {
                window.deleteMedicalRecordFile = async function(fileId) {
                    if (!confirm('Are you sure you want to delete this file?')) {
                        return;
                    }

                    try {
                        const formData = new FormData();
                        let token = document.querySelector('input[name="__RequestVerificationToken"]');
                        if (token) {
                            formData.append('__RequestVerificationToken', token.value);
                        }

                        const response = await fetch(`/Precord/DeleteMedicalRecordFile/${fileId}`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('File deleted successfully!');
                            // Reload the details modal content
                            const modalBody = document.getElementById('detailsModalBody');
                            if (modalBody) {
                                const patientIdMatch = modalBody.innerHTML.match(/data-patient-id="(\d+)"/);
                                if (patientIdMatch) {
                                    setTimeout(() => showDetailsModal(parseInt(patientIdMatch[1])), 500);
                                }
                            }
                        } else {
                            throw new Error(result.message || 'Failed to delete file');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert(error.message || 'Error deleting file. Please try again.');
                    }
                };
            }
            
            // Initialize upload form handler
            const uploadForm = document.getElementById('uploadFileForm');
            if (uploadForm && !uploadForm.dataset.handlerAttached) {
                uploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const patientIdInput = document.getElementById('uploadPatientId');
                    const patientId = patientIdInput ? parseInt(patientIdInput.value) : null;
                    if (!patientId || isNaN(patientId)) {
                        alert('Invalid patient ID. Please try again.');
                        return;
                    }
                    await window.uploadMedicalRecordFile(patientId);
                });
                uploadForm.dataset.handlerAttached = 'true';
            }
        }

    </script>
}
