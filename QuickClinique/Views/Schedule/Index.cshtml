@model IEnumerable<QuickClinique.Models.Schedule>

@{
    ViewData["Title"] = "Schedules";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/schedIndex.css" />
}

<div class="schedules-container">
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-calendar-alt"></i> Clinic Schedules</h1>
            <div class="header-actions">
                <div class="btn-group">
                    <a asp-action="Availability" class="btn btn-info">
                        <i class="fas fa-list-check"></i> View Availability
                    </a>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create New Schedule
                    </a>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                            Create Multiple
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" asp-action="CreateMultiple">
                                    <i class="fas fa-calendar-week"></i> Date Range Create
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-action="CreateQuick">
                                    <i class="fas fa-bolt"></i> Quick Create
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="schedules-card">
        <div class="card-header">
            <div class="header-content">
                <h5 class="card-title">
                    <i class="fas fa-table"></i> All Schedules
                    <span class="badge count-badge">@Model.Count()</span>
                </h5>
                <div class="bulk-actions" id="bulkActions" style="display: none;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="showBulkDeleteModal()">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="schedules-table">
                    <thead>
                        <tr>
                            <th class="checkbox-column">
                                <input type="checkbox" id="selectAll" />
                            </th>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Availability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="schedule-row">
                                <td class="checkbox-column">
                                    <input type="checkbox" name="scheduleIds" value="@item.ScheduleId" class="schedule-checkbox" />
                                </td>
                                <td class="date-cell">
                                    <div class="date-info">
                                        <span class="date">@item.Date.ToString("yyyy-MM-dd")</span>
                                        <small class="day">@item.Date.DayOfWeek</small>
                                    </div>
                                </td>
                                <td class="time-cell">
                                    <span class="time-slot">@item.StartTime.ToString("hh\\:mm tt")</span>
                                </td>
                                <td class="time-cell">
                                    <span class="time-slot">@item.EndTime.ToString("hh\\:mm tt")</span>
                                </td>
                                <td class="availability-cell">
                                    <span class="availability-badge @(item.IsAvailable == "Yes" ? "available" : "unavailable")">
                                        <i class="fas @(item.IsAvailable == "Yes" ? "fa-check" : "fa-times")"></i>
                                        @item.IsAvailable
                                    </span>
                                </td>
                                <td class="actions-cell">
                                    <div class="action-buttons">
                                        <a asp-action="Details" asp-route-id="@item.ScheduleId" class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i> Details
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@item.ScheduleId" class="btn btn-warning btn-sm">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <button type="button" class="btn btn-danger btn-sm delete-btn"
                                                onclick="setDeleteSchedule(@item.ScheduleId, '@item.Date.ToString("yyyy-MM-dd")', '@item.StartTime.ToString("hh\\:mm tt") - @item.EndTime.ToString("hh\\:mm tt")', @(item.Appointments?.Count ?? 0))">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (!Model.Any())
            {
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h4>No Schedules Found</h4>
                    <p class="text-muted">There are no schedules available. Create your first schedule to get started.</p>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create First Schedule
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header danger-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Bulk Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="warning-banner">
                    <i class="fas fa-radiation"></i>
                    <div>
                        <h6>Delete Multiple Schedules</h6>
                        <p class="mb-0">Are you sure you want to delete <strong id="selectedCount">0</strong> schedule(s)? This action cannot be undone.</p>
                    </div>
                </div>

                <div class="critical-warning">
                    <i class="fas fa-skull-crossbones"></i>
                    <div>
                        <strong>Critical Warning</strong>
                        <p>Deleting these schedules will permanently remove all associated appointments. This action is irreversible.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <form id="bulkDeleteForm" method="post" asp-action="BulkDelete">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Selected Schedules
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Single Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header danger-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="warning-banner">
                    <i class="fas fa-radiation"></i>
                    <div>
                        <h6>Delete Schedule</h6>
                        <p class="mb-0">Are you sure you want to delete this schedule? This action cannot be undone.</p>
                    </div>
                </div>

                <div class="delete-details">
                    <div class="detail-row">
                        <span class="label">Date:</span>
                        <span class="value" id="deleteDate"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Time Slot:</span>
                        <span class="value" id="deleteTime"></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Appointments:</span>
                        <span class="value">
                            <span class="appointment-count" id="deleteAppointmentsBadge">
                                <i class="fas fa-calendar-check"></i>
                                <span id="appointmentsText">0 appointment(s)</span>
                            </span>
                        </span>
                    </div>
                </div>

                <div class="critical-warning" id="appointmentsWarning">
                    <i class="fas fa-skull-crossbones"></i>
                    <div>
                        <strong>Critical Warning</strong>
                        <p>This schedule has <span id="appointmentsCount">0</span> active appointment(s). Deleting this schedule will permanently remove all associated appointments.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <form id="deleteForm" asp-action="Delete" method="post" class="delete-form">
                    <input type="hidden" name="id" id="deleteScheduleId" />
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Schedule
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
        // Aggressive backdrop removal function
        function removeBackdrop() {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                // Make it completely invisible and non-interactive
                backdrop.style.display = 'none';
                backdrop.style.visibility = 'hidden';
                backdrop.style.opacity = '0';
                backdrop.style.pointerEvents = 'none';
                backdrop.style.zIndex = '-1';
                backdrop.style.background = 'transparent';
                backdrop.remove();
            });
            // Also remove modal-open class to prevent body scroll lock
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // Override Bootstrap's backdrop methods for delete modals
        const originalShow = bootstrap.Modal.prototype.show;
        const originalShowBackdrop = bootstrap.Modal.prototype._showBackdrop;
        
        // Override _showBackdrop to prevent backdrop from showing for our modals
        if (originalShowBackdrop) {
            bootstrap.Modal.prototype._showBackdrop = function(callback) {
                const modalElement = this._element;
                if (modalElement && (modalElement.id === 'deleteModal' || modalElement.id === 'bulkDeleteModal')) {
                    // Don't show backdrop, just call callback directly
                    if (callback) {
                        callback();
                    }
                    return;
                }
                originalShowBackdrop.call(this, callback);
            };
        }
        
        bootstrap.Modal.prototype.show = function() {
            const modalElement = this._element;
            if (modalElement && (modalElement.id === 'deleteModal' || modalElement.id === 'bulkDeleteModal')) {
                // Force backdrop to false
                this._config.backdrop = false;
                
                // Remove any existing backdrop
                if (this._backdrop) {
                    if (this._backdrop._element) {
                        this._backdrop._element.remove();
                    }
                    this._backdrop = null;
                }
                
                // Call original show
                originalShow.call(this);
                
                // Immediately remove any backdrop that might have been created
                setTimeout(removeBackdrop, 0);
                setTimeout(removeBackdrop, 10);
            } else {
                originalShow.call(this);
            }
        };

        // MutationObserver to watch for backdrop creation - More aggressive
        const backdropObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) {
                        // Check if it's a backdrop element
                        if (node.classList && (node.classList.contains('modal-backdrop') || 
                            (node.classList.contains('fade') && node.classList.contains('show')))) {
                            // Immediately remove and prevent it
                            node.style.display = 'none';
                            node.style.visibility = 'hidden';
                            node.style.pointerEvents = 'none';
                            node.style.opacity = '0';
                            node.remove();
                            return;
                        }
                        // Also check for backdrop in children
                        if (node.querySelectorAll) {
                            const backdrops = node.querySelectorAll('.modal-backdrop');
                            backdrops.forEach(backdrop => {
                                backdrop.style.display = 'none';
                                backdrop.style.visibility = 'hidden';
                                backdrop.style.pointerEvents = 'none';
                                backdrop.remove();
                            });
                        }
                    }
                });
            });
        });

        // Start observing the document body for backdrop additions
        backdropObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class']
        });
        
        // Also observe for class changes that might add 'show' class to backdrop
        backdropObserver.observe(document.documentElement, {
            childList: true,
            subtree: true
        });

        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeCheckboxHandlers();
            initializeRowHoverEffects();
            
            // Set up event listeners for bulk delete modal
            const bulkDeleteModalElement = document.getElementById('bulkDeleteModal');
            if (bulkDeleteModalElement) {
                // Prevent backdrop creation before modal shows
                bulkDeleteModalElement.addEventListener('show.bs.modal', function(e) {
                    removeBackdrop();
                }, true); // Use capture phase to run early
                
                bulkDeleteModalElement.addEventListener('shown.bs.modal', function(e) {
                    removeBackdrop();
                    setTimeout(removeBackdrop, 10);
                    setTimeout(removeBackdrop, 50);
                    setTimeout(removeBackdrop, 100);
                    setTimeout(removeBackdrop, 200);
                });
                
                // Ensure modal is interactive
                bulkDeleteModalElement.style.zIndex = '1060';
            }
        });

        function initializeCheckboxHandlers() {
            const selectAll = document.getElementById('selectAll');
            const scheduleCheckboxes = document.querySelectorAll('.schedule-checkbox');

            // Select All functionality
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    scheduleCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    toggleBulkActions();
                });
            }

            // Individual checkbox change
            scheduleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Update select all checkbox state
                    if (selectAll) {
                        const allChecked = document.querySelectorAll('.schedule-checkbox:checked').length === scheduleCheckboxes.length;
                        const someChecked = document.querySelectorAll('.schedule-checkbox:checked').length > 0;

                        selectAll.checked = allChecked;
                        selectAll.indeterminate = someChecked && !allChecked;
                    }
                    toggleBulkActions();
                });
            });

            // Initial toggle
            toggleBulkActions();
        }

        function toggleBulkActions() {
            const checkedCount = document.querySelectorAll('.schedule-checkbox:checked').length;
            const bulkActions = document.getElementById('bulkActions');

            if (bulkActions) {
                if (checkedCount > 0) {
                    bulkActions.style.display = 'flex';
                } else {
                    bulkActions.style.display = 'none';
                }
            }
        }

        function showBulkDeleteModal() {
            const checkedCheckboxes = document.querySelectorAll('.schedule-checkbox:checked');
            const checkedCount = checkedCheckboxes.length;

            if (checkedCount === 0) {
                alert('Please select at least one schedule to delete.');
                return;
            }

            // Update the selected count in the modal
            document.getElementById('selectedCount').textContent = checkedCount;

            // Clear existing hidden inputs from the form
            const bulkDeleteForm = document.getElementById('bulkDeleteForm');
            const existingInputs = bulkDeleteForm.querySelectorAll('input[name="scheduleIds"]');
            existingInputs.forEach(input => input.remove());

            // Add selected schedule IDs to the form
            checkedCheckboxes.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'scheduleIds';
                input.value = checkbox.value;
                bulkDeleteForm.appendChild(input);
            });

            // Show the modal without backdrop
            const modalElement = document.getElementById('bulkDeleteModal');
            
            // Remove any existing backdrop first
            removeBackdrop();
            
            // Get or create modal instance with backdrop explicitly disabled
            let bulkDeleteModal = bootstrap.Modal.getInstance(modalElement);
            if (bulkDeleteModal) {
                // Dispose existing instance to recreate with new config
                bulkDeleteModal.dispose();
            }
            
            // Create new instance with backdrop disabled
            bulkDeleteModal = new bootstrap.Modal(modalElement, { 
                backdrop: false,
                keyboard: true,
                focus: true
            });
            
            // CRITICAL: Ensure the config is set correctly and backdrop is null
            bulkDeleteModal._config.backdrop = false;
            if (bulkDeleteModal._backdrop) {
                if (bulkDeleteModal._backdrop._element) {
                    bulkDeleteModal._backdrop._element.remove();
                }
                bulkDeleteModal._backdrop = null;
            }
            
            // Ensure modal has high z-index and is interactive BEFORE showing
            modalElement.style.zIndex = '9999';
            modalElement.style.pointerEvents = 'auto';
            modalElement.style.position = 'fixed';
            modalElement.classList.add('no-backdrop');
            
            const modalDialog = modalElement.querySelector('.modal-dialog');
            if (modalDialog) {
                modalDialog.style.pointerEvents = 'auto';
                modalDialog.style.zIndex = '10000';
                modalDialog.style.position = 'relative';
            }
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
                modalContent.style.zIndex = '10001';
                modalContent.style.position = 'relative';
            }
            
            // Make all buttons and forms interactive
            const allButtons = modalElement.querySelectorAll('button, .btn, form, input, select, textarea');
            allButtons.forEach(btn => {
                btn.style.pointerEvents = 'auto';
                btn.style.zIndex = '10002';
                btn.style.position = 'relative';
            });
            
            // Remove backdrop immediately before showing
            removeBackdrop();
            
            // Hook into the show event to prevent backdrop
            const showHandler = function(e) {
                e.stopPropagation();
                removeBackdrop();
                // Prevent backdrop from being created
                if (bulkDeleteModal._backdrop) {
                    if (bulkDeleteModal._backdrop._element) {
                        bulkDeleteModal._backdrop._element.remove();
                    }
                    bulkDeleteModal._backdrop = null;
                }
                // Force backdrop config to false
                bulkDeleteModal._config.backdrop = false;
            };
            
            modalElement.addEventListener('show.bs.modal', showHandler, { once: true, capture: true });
            modalElement.addEventListener('shown.bs.modal', function() {
                removeBackdrop();
                // Ensure backdrop is still null
                if (bulkDeleteModal._backdrop) {
                    if (bulkDeleteModal._backdrop._element) {
                        bulkDeleteModal._backdrop._element.remove();
                    }
                    bulkDeleteModal._backdrop = null;
                }
                bulkDeleteModal._config.backdrop = false;
                setTimeout(removeBackdrop, 0);
                setTimeout(removeBackdrop, 10);
                setTimeout(removeBackdrop, 50);
                setTimeout(removeBackdrop, 100);
                setTimeout(removeBackdrop, 200);
            }, { once: true });
            
            // Show the modal
            bulkDeleteModal.show();
            
            // Immediately after show, ensure backdrop is disabled
            setTimeout(() => {
                if (bulkDeleteModal._backdrop) {
                    if (bulkDeleteModal._backdrop._element) {
                        bulkDeleteModal._backdrop._element.remove();
                    }
                    bulkDeleteModal._backdrop = null;
                }
                bulkDeleteModal._config.backdrop = false;
            }, 0);
            
            // Aggressively remove backdrop multiple times after showing
            setTimeout(removeBackdrop, 0);
            setTimeout(removeBackdrop, 10);
            setTimeout(removeBackdrop, 50);
            setTimeout(removeBackdrop, 100);
            setTimeout(removeBackdrop, 200);
            setTimeout(removeBackdrop, 500);
            
            // Use requestAnimationFrame for immediate removal
            requestAnimationFrame(() => {
                removeBackdrop();
                requestAnimationFrame(() => {
                    removeBackdrop();
                    // Double check backdrop is null
                    if (bulkDeleteModal._backdrop) {
                        if (bulkDeleteModal._backdrop._element) {
                            bulkDeleteModal._backdrop._element.remove();
                        }
                        bulkDeleteModal._backdrop = null;
                    }
                });
            });
            
            // Continuous monitoring for a short period
            let checkCount = 0;
            const backdropChecker = setInterval(() => {
                removeBackdrop();
                // Also check and nullify backdrop object
                if (bulkDeleteModal._backdrop) {
                    if (bulkDeleteModal._backdrop._element) {
                        bulkDeleteModal._backdrop._element.remove();
                    }
                    bulkDeleteModal._backdrop = null;
                }
                checkCount++;
                if (checkCount > 30) { // Check for 3 seconds
                    clearInterval(backdropChecker);
                }
            }, 100);
        }

        function setDeleteSchedule(scheduleId, date, time, appointmentCount) {
            // Set the values in the modal
            document.getElementById('deleteScheduleId').value = scheduleId;
            document.getElementById('deleteDate').textContent = date;
            document.getElementById('deleteTime').textContent = time;

            // Update appointments info
            const appointmentsBadge = document.getElementById('deleteAppointmentsBadge');
            const appointmentsWarning = document.getElementById('appointmentsWarning');
            const appointmentsCount = document.getElementById('appointmentsCount');
            const appointmentsText = document.getElementById('appointmentsText');

            appointmentsText.textContent = appointmentCount + ' appointment(s)';
            appointmentsCount.textContent = appointmentCount;

            if (appointmentCount > 0) {
                appointmentsBadge.className = 'appointment-count has-appointments';
                appointmentsWarning.style.display = 'flex';
            } else {
                appointmentsBadge.className = 'appointment-count no-appointments';
                appointmentsWarning.style.display = 'none';
            }

            // Show the modal without backdrop
            const modalElement = document.getElementById('deleteModal');
            const deleteModal = new bootstrap.Modal(modalElement, { 
                backdrop: false,
                keyboard: true
            });
            
            // Ensure modal has high z-index and is interactive
            modalElement.style.zIndex = '1060';
            const modalDialog = modalElement.querySelector('.modal-dialog');
            if (modalDialog) {
                modalDialog.style.pointerEvents = 'auto';
            }
            
            deleteModal.show();
            
            // Aggressively remove backdrop multiple times
            removeBackdrop();
            setTimeout(removeBackdrop, 10);
            setTimeout(removeBackdrop, 50);
            setTimeout(removeBackdrop, 100);
            setTimeout(removeBackdrop, 200);
        }

        function initializeRowHoverEffects() {
            const scheduleRows = document.querySelectorAll('.schedule-row');
            scheduleRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(5px)';
                });

                row.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateX(0)';
                });
            });
        }

    </script>
}