@{
    ViewData["Title"] = "Email Verification";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuickClinic - Email Verification</title>
    <link rel="icon" type="image/png" href="~/img/logo.png" />
    <link rel="stylesheet" href="~/css/studVerificationE.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
    <div class="container">
        <div class="side-panel">
            <div class="logo">
                <img src="~/img/logo.png" alt="QuickClinic Logo" class="logo-img">
            </div>
            <h1 class="clinic-name">QuickClinique</h1>
            <p class="tagline">Your Health, Our Priority</p>
            <div class="medical-icons">
                <div class="floating-icon">üíä</div>
                <div class="floating-icon">ü©∫</div>
                <div class="floating-icon">‚ù§Ô∏è</div>
                <div class="floating-icon">üè•</div>
                <div class="floating-icon">üî¨</div>
                <div class="floating-icon">ü©π</div>
            </div>
        </div>

        <div class="form-panel">
            <div class="form-container">
                <h2 class="form-title">Email Verification</h2>
                <p class="form-subtitle">We've sent a verification link to your email</p>

                <div class="verification-icon">
                    <i class="fas fa-envelope"></i>
                    <span class="at-symbol">@@</span>
                </div>

                <div class="verification-message">
                    <p>Please check your email and click on the verification link to activate your account.</p>
                    <p class="expiry-notice">The verification link will expire in an hour.</p>
                </div>

                <div class="resend-section">
                    <p class="resend-question">Didn't receive the verification link?</p>
                    <button type="button" class="resend-btn" id="resendBtn">
                        <span class="btn-text">Resend Verification Link</span>
                        <span class="btn-loader"></span>
                    </button>
                </div>

                <div class="back-to-login">
                    <a asp-action="Login" class="back-link">Back to Login</a>
                </div>
            </div>
        </div>
    </div>

    @Html.AntiForgeryToken()
    @if (ViewBag.Email != null)
    {
        <input type="hidden" id="serverEmail" value="@ViewBag.Email" />
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resendBtn = document.getElementById('resendBtn');

            // Function to get anti-forgery token
            function getAntiForgeryToken() {
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenInput ? tokenInput.value : null;
            }

            // Function to get email from URL parameter or server-side hidden input
            function getEmail() {
                // Try to get from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                let email = urlParams.get('email');
                
                // Try to get from server-side hidden input
                if (!email) {
                    const emailInput = document.getElementById('serverEmail');
                    if (emailInput) {
                        email = emailInput.value;
                    }
                }
                
                return email;
            }

            resendBtn.addEventListener('click', async function() {
                let email = getEmail();
                
                // If no email found, prompt user
                if (!email) {
                    const userEmail = prompt('Please enter your email address:');
                    if (!userEmail) {
                        return; // User cancelled
                    }
                    
                    // Use the entered email
                    email = userEmail;
                }

                // Disable button and show loader
                resendBtn.disabled = true;
                resendBtn.classList.add('loading');

                try {
                    const token = getAntiForgeryToken();
                    const formData = new FormData();
                    
                    // Add email to form data
                    formData.append('Email', email);
                    
                    // Add anti-forgery token to form data
                    if (token) {
                        formData.append('__RequestVerificationToken', token);
                    }

                    const response = await fetch('@Url.Action("ResendVerificationEmail", "Student")', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        throw new Error(`Expected JSON but got: ${contentType}. Response: ${text.substring(0, 100)}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message || 'Verification email has been sent. Please check your inbox (and spam folder).');
                    } else {
                        alert(result.error || 'An error occurred. Please try again later.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again later. ' + (error.message || ''));
                } finally {
                    // Re-enable button and hide loader
                    resendBtn.disabled = false;
                    resendBtn.classList.remove('loading');
                }
            });
        });
    </script>
</body>
</html>

