@model QuickClinique.Models.Student
@{
    ViewData["Title"] = "My Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
}

<div class="student-dashboard">
    <div class="dashboard-container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1><i class="fas fa-hand-wave"></i> Welcome back, @Model.FirstName!</h1>
            <p>Here's an overview of your appointments and health information</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3 id="totalAppointments">0</h3>
                <p>Total Appointments</p>
            </div>

            <div class="stat-card success">
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 id="completedAppointments">0</h3>
                <p>Completed</p>
            </div>

            <div class="stat-card warning">
                <div class="icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 id="pendingAppointments">0</h3>
                <p>Pending</p>
            </div>

            <div class="stat-card info">
                <div class="icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h3 id="upcomingAppointments">0</h3>
                <p>Upcoming</p>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Clinic Communications Section -->
            <div class="appointments-section">
                <div class="section-header">
                    <h2><i class="fas fa-comments"></i> Clinic Communications</h2>
                    <button class="btn btn-sm btn-primary" onclick="loadMessages()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="messaging-container messaging-container-mt">
                    <div class="chat-header chat-header-gradient">
                        <i class="fas fa-user-md"></i> Clinic Staff
                    </div>
                    <div class="chat-messages chat-messages-container" id="chatMessages">
                        <div class="message received">
                            <div class="message-content">
                                Welcome to QuickClinique! How can we assist you today?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                    <div class="chat-input chat-input-flex">
                        <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500" class="chat-input-field">
                        <button class="btn btn-primary chat-send-btn" id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="quick-actions">
                <!-- Profile Card -->
                <div class="profile-card">
                    <h3><i class="fas fa-user-circle"></i> My Profile</h3>
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <i class="fas fa-id-card"></i>
                            <span>@Model.Idnumber</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-envelope"></i>
                            <span>@Model.Email</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-phone"></i>
                            <span>@Model.PhoneNumber</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <h4>
                    <i class="fas fa-bolt"></i> Quick Actions
                </h4>

                <button type="button" class="action-btn sos-btn" data-bs-toggle="modal" data-bs-target="#sosModal">
                    <i class="fas fa-exclamation-triangle"></i> SOS Emergency
                </button>

                <a href="@Url.Action("Index", "Home")" class="action-btn">
                    <i class="fas fa-calendar-plus"></i> Set Appointment
                </a>

                <a href="@Url.Action("Profile", "Student")" class="action-btn secondary">
                    <i class="fas fa-user-edit"></i> Edit Profile
                </a>

                <a href="@Url.Action("History", "Student")" class="action-btn secondary">
                    <i class="fas fa-history"></i> View History
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Mission & Vision Section -->
    <section class="section" id="mission">
        <div class="section-header">
            <h2>Our Mission & Vision</h2>
            <p>Guiding principles that drive our healthcare services</p>
        </div>
        <div class="mission-vision">
            <div class="vision-card">
                <h3><i class="fas fa-eye"></i> VISION</h3>
                <p>"As a Health Care Provider, the University of Cebu – Main goal is to render efficient Medical and Dental Services to the UC Community as a whole, and to promote good health and well-being of students that will highly contribute to their success."</p>
            </div>
            <div class="mission-card">
                <h3><i class="fas fa-bullseye"></i> MISSION</h3>
                <p>"Diverse implements, effective and accessible antidote for any malady and the health teaching that will be bestowed/ inculcated by the Clinicians to the minds of every individual who will be going to the Clinic are what the endeavor uses and does to ensure that the wellness of the health among UC populace is at hand."</p>
            </div>
        </div>
        <div class="staff-section">
            <h3 class="clinic-title">MEDICAL- DENTAL CLINIC</h3>
            <p class="clinic-description">"The UC Medical- Dental Clinic aims to promote good health and total well- being of the students, the teachers and the employees through prevention, diagnosis, treatment of disease, and education."</p>
        </div>
    </section>

    <!-- Staff Section -->
    <section class="section" id="staff">
        <div class="section-header">
            <h2>Our Medical & Dental Staff</h2>
            <p>Meet our dedicated healthcare professionals</p>
        </div>
        <div class="staff-section">
            <div class="staff-category">
                <h3>MEDICAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Carolyn Go- Uang</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Jewel Ann Marie Abella</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Hermogina Jao- Co</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 5:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Rosalinda Margallo</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>DENTAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Concepcion Tundag</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Cherryl Abineta- Asibal</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Emmanuel Mercado</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 1:00 PM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Frances Mae Licong</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>NURSING STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Mrs. Paz Colina Po, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Charlene Gallentes, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Lloyd Dabon, DMD, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 1:30 PM - 9:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Nancy Ong, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Ms. Therese Bacalso, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 10:30 AM - 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Objectives Section -->
    <section class="section" id="objectives">
        <div class="section-header">
            <h2>Department Objectives</h2>
            <p>Our commitment to comprehensive healthcare services</p>
        </div>
        <div class="objectives">
            <h3>DEPARTMENT OBJECTIVES:</h3>
            <ul class="objectives-list">
                <li>Provide preventive measures through BP taking and physical examination, oral examination and prophylaxis;</li>
                <li>Diagnose diseases based on the patient's history, clinical and laboratory findings;</li>
                <li>Give treatment to specific diseases based on diagnosis.</li>
                <li>Conduct Medical- Dental awareness and education through posters and counseling.</li>
            </ul>
        </div>
    </section>
</div>

<!-- SOS Emergency Modal -->
<div class="modal fade" id="sosModal" tabindex="-1" aria-labelledby="sosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="sosModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> SOS Emergency Request
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> <strong>Emergency Alert:</strong> This will notify clinic staff immediately. Use only for genuine emergencies.
                </div>

                <form id="sosForm">
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Student Name</label>
                        <input type="text" class="form-control" id="studentName" value="@Model.FirstName @Model.LastName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="studentIdNumber" class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="studentIdNumber" value="@Model.Idnumber" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="sosLocation" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sosLocation" placeholder="e.g., Building A, Room 201" required>
                        <small class="form-text text-muted">Where are you located?</small>
                        <div class="invalid-feedback" id="locationError"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Needs <span class="text-danger">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="needFirstAid" value="First Aid Kit">
                            <label class="form-check-label" for="needFirstAid">First Aid Kit</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="needWheelchair" value="Wheelchair">
                            <label class="form-check-label" for="needWheelchair">Wheelchair</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="needStretcher" value="Stretcher">
                            <label class="form-check-label" for="needStretcher">Stretcher</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="needOther" value="Other">
                            <label class="form-check-label" for="needOther">Other</label>
                        </div>
                        <div class="mt-2" id="otherInputContainer" style="display: none;">
                            <input type="text" class="form-control" id="otherInput" placeholder="Please specify">
                        </div>
                        <div class="invalid-feedback" id="needsError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="sendSOSBtn">
                    <i class="fas fa-paper-plane"></i> Send SOS
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        let connection = null;
        let currentUserId = null;

        $(document).ready(function() {
            initializeMessaging();
        });

        // Initialize messaging with SignalR
        async function initializeMessaging() {
            console.log('Initializing messaging with SignalR...');
            
            // First, get current user ID and load initial messages
            await loadMessages();
            
            // Initialize SignalR connection
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/messageHub")
                .withAutomaticReconnect()
                .build();

            // Handle incoming messages
            connection.on("ReceiveMessage", function (message) {
                console.log('Received message via SignalR:', message);
                addMessageToChat(message);
            });

            // Handle connection events
            connection.onreconnecting(() => {
                console.log('SignalR reconnecting...');
            });

            connection.onreconnected(() => {
                console.log('SignalR reconnected');
                // Rejoin user group after reconnection
                if (currentUserId) {
                    connection.invoke("JoinUserGroup", currentUserId).catch(err => console.error(err));
                }
            });

            connection.onclose(() => {
                console.log('SignalR connection closed');
            });

            // Start connection
            try {
                await connection.start();
                console.log('SignalR connected');

                // Join user group after connection is established
                if (currentUserId) {
                    await connection.invoke("JoinUserGroup", currentUserId);
                    console.log('Joined user group:', currentUserId);
                }
            } catch (err) {
                console.error('Error starting SignalR connection:', err);
                // Fallback to polling if SignalR fails
                startMessagingAutoRefresh();
            }

            // Send message button click
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessageToStaff);
            }

            // Send message on Enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessageToStaff();
                    }
                });
            }
        }

        // Load messages from server
        async function loadMessages() {
            try {
                const response = await fetch('/Home/GetMessages');
                const result = await response.json();

                if (result.success && result.data) {
                    currentUserId = result.currentUserId;
                    displayMessages(result.data);
                } else {
                    console.error('Failed to load messages:', result.error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Add a single message to the chat (for real-time updates)
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Check if message already exists (prevent duplicates)
            const existingMessage = chatMessages.querySelector(`[data-message-id="${message.messageId}"]`);
            if (existingMessage) {
                return;
            }

            const messageClass = message.isSent ? 'sent' : 'received';
            const messageTime = formatMessageTime(message.createdAt);
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${messageClass}`;
            messageElement.setAttribute('data-message-id', message.messageId);
            messageElement.innerHTML = `
                <div class="message-content">${escapeHtml(message.message)}</div>
                <div class="message-time">${messageTime}</div>
            `;

            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Display messages in the chat
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="message received">
                        <div class="message-content">
                            Welcome to QuickClinique! How can we assist you today?
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(msg => {
                const messageClass = msg.isSent ? 'sent' : 'received';
                const messageTime = formatMessageTime(msg.createdAt);
                
                return `
                    <div class="message ${messageClass}">
                        <div class="message-content">${escapeHtml(msg.message)}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to clinic staff
        async function sendMessageToStaff() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText) {
                return;
            }

            // Disable send button
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/Home/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ message: messageText })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear input
                    messageInput.value = '';

                    // Message will be added via SignalR, but we can also add it immediately for better UX
                    if (result.data) {
                        addMessageToChat(result.data);
                    }
                } else {
                    alert('Failed to send message: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Format message timestamp
        function formatMessageTime(timestamp) {
            // Ensure timestamp is treated as UTC if it doesn't have timezone info
            let date;
            if (typeof timestamp === 'string') {
                // If timestamp doesn't end with Z or have timezone, assume it's UTC
                if (!timestamp.endsWith('Z') && !timestamp.includes('+') && !timestamp.includes('-', 10)) {
                    // Add Z to indicate UTC if not present
                    date = new Date(timestamp + (timestamp.includes('T') ? 'Z' : ''));
                } else {
                    date = new Date(timestamp);
                }
            } else {
                date = new Date(timestamp);
            }
            
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            // Handle negative differences (future dates) or very small differences
            if (diffMs < 0 || diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hr ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fallback: Start auto-refresh for messages (only used if SignalR fails)
        function startMessagingAutoRefresh() {
            console.log('Using polling fallback for messages');
            return setInterval(function() {
                loadMessages();
            }, 10000); // Refresh every 10 seconds
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (connection) {
                connection.stop();
            }
        });
    </script>

    <script>
        // Show/hide other input based on checkbox
        document.getElementById('needOther').addEventListener('change', function() {
            document.getElementById('otherInputContainer').style.display = this.checked ? 'block' : 'none';
        });

        // Handle SOS form submission
        document.getElementById('sendSOSBtn').addEventListener('click', async function() {
            const location = document.getElementById('sosLocation').value.trim();
            const needs = [];
            
            if (document.getElementById('needFirstAid').checked) {
                needs.push('First Aid Kit');
            }
            if (document.getElementById('needWheelchair').checked) {
                needs.push('Wheelchair');
            }
            if (document.getElementById('needStretcher').checked) {
                needs.push('Stretcher');
            }
            if (document.getElementById('needOther').checked) {
                const otherValue = document.getElementById('otherInput').value.trim();
                if (otherValue) {
                    needs.push('Other: ' + otherValue);
                } else {
                    needs.push('Other');
                }
            }

            // Validation
            let isValid = true;
            document.getElementById('locationError').textContent = '';
            document.getElementById('needsError').textContent = '';
            
            if (!location) {
                document.getElementById('locationError').textContent = 'Location is required';
                document.getElementById('sosLocation').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('sosLocation').classList.remove('is-invalid');
            }

            if (needs.length === 0) {
                document.getElementById('needsError').textContent = 'Please select at least one need';
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // Disable button and show loading
            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('/Student/SendSOS', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        location: location,
                        needs: needs.join(', ')
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    alert('SOS emergency request sent successfully! Clinic staff has been notified.');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sosModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('sosForm').reset();
                    document.getElementById('otherInputContainer').style.display = 'none';
                } else {
                    alert('Failed to send SOS: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending SOS:', error);
                alert('Error sending SOS: ' + (error.message || 'Please try again.'));
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    </script>

    <style>
        .sos-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            box-shadow: 0 4px 14px rgba(220, 53, 69, 0.5) !important;
            animation: pulse-red 2s infinite;
        }

        .sos-btn:hover {
            box-shadow: 0 8px 24px rgba(220, 53, 69, 0.7) !important;
            animation: none;
        }

        @@keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 4px 14px rgba(220, 53, 69, 0.5);
            }
            50% {
                box-shadow: 0 4px 20px rgba(220, 53, 69, 0.8), 0 0 0 4px rgba(220, 53, 69, 0.2);
            }
        }
    </style>
}