@model QuickClinique.Models.Student
@{
    ViewData["Title"] = "My Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
}

<div class="student-dashboard">
    <div class="dashboard-container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1><i class="fas fa-hand-wave"></i> Welcome back, @Model.FirstName!</h1>
            <p>Here's an overview of your appointments and health information</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3 id="totalAppointments">0</h3>
                <p>Total Appointments</p>
            </div>

            <div class="stat-card success">
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 id="completedAppointments">0</h3>
                <p>Completed</p>
            </div>

            <div class="stat-card warning">
                <div class="icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 id="pendingAppointments">0</h3>
                <p>Pending</p>
            </div>

            <div class="stat-card info">
                <div class="icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h3 id="upcomingAppointments">0</h3>
                <p>Upcoming</p>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Clinic Communications Section -->
            <div class="appointments-section">
                <div class="section-header">
                    <h2><i class="fas fa-comments"></i> Clinic Communications</h2>
                    <button class="btn btn-sm btn-primary" onclick="loadMessages()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="messaging-container messaging-container-mt">
                    <div class="chat-header chat-header-gradient">
                        <i class="fas fa-user-md"></i> Clinic Staff
                    </div>
                    <div class="chat-messages chat-messages-container" id="chatMessages">
                        <div class="message received">
                            <div class="message-content">
                                Welcome to QuickClinique! How can we assist you today?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                    <div class="chat-input chat-input-flex">
                        <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500" class="chat-input-field">
                        <button class="btn btn-primary chat-send-btn" id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="quick-actions">
                <!-- Profile Card -->
                <div class="profile-card">
                    <h3><i class="fas fa-user-circle"></i> My Profile</h3>
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <i class="fas fa-id-card"></i>
                            <span>@Model.Idnumber</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-envelope"></i>
                            <span>@Model.Email</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-phone"></i>
                            <span>@Model.PhoneNumber</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <h4>
                    <i class="fas fa-bolt"></i> Quick Actions
                </h4>

                <a href="@Url.Action("Index", "Home")" class="action-btn">
                    <i class="fas fa-calendar-plus"></i> Set Appointment
                </a>

                <a href="@Url.Action("Profile", "Student")" class="action-btn secondary">
                    <i class="fas fa-user-edit"></i> Edit Profile
                </a>

                <a href="@Url.Action("History", "Student")" class="action-btn secondary">
                    <i class="fas fa-history"></i> View History
                </a>

                <button type="button" class="action-btn sos-btn" data-bs-toggle="modal" data-bs-target="#sosModal">
                    <i class="fas fa-exclamation-triangle"></i> SOS Emergency
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SOS Emergency Modal -->
<div class="modal fade" id="sosModal" tabindex="-1" aria-labelledby="sosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header sos-header">
                <h5 class="modal-title" id="sosModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Emergency SOS Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> <strong>Emergency Alert:</strong> This will notify clinic staff immediately. Use only for genuine emergencies.
                </div>

                <form id="sosForm">
                    <div class="form-group mb-3">
                        <label for="studentName"><i class="fas fa-user"></i> Student Name</label>
                        <input type="text" class="form-control" id="studentName" value="@Model.FirstName @Model.LastName" readonly />
                    </div>

                    <div class="form-group mb-3">
                        <label for="studentId"><i class="fas fa-id-card"></i> Student ID</label>
                        <input type="text" class="form-control" id="studentId" value="@Model.Idnumber" readonly />
                    </div>

                    <div class="form-group mb-3">
                        <label for="emergencyLocation"><i class="fas fa-map-marker-alt"></i> Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="emergencyLocation" placeholder="Enter your current location" required />
                        <small class="form-text text-muted">e.g., Building A, Room 201 or Main Campus, Library</small>
                    </div>

                    <div class="form-group mb-3">
                        <label><i class="fas fa-tools"></i> What do you need? <span class="text-danger">*</span></label>
                        <div class="needs-options">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="needs" value="First Aid Kit" id="needFirstAid">
                                <label class="form-check-label" for="needFirstAid">
                                    <i class="fas fa-medkit"></i> First Aid Kit
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="needs" value="Wheelchair" id="needWheelchair">
                                <label class="form-check-label" for="needWheelchair">
                                    <i class="fas fa-wheelchair"></i> Wheelchair
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="needs" value="Stretcher" id="needStretcher">
                                <label class="form-check-label" for="needStretcher">
                                    <i class="fas fa-bed"></i> Stretcher
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="needs" value="Other" id="needOther">
                                <label class="form-check-label" for="needOther">
                                    <i class="fas fa-ellipsis-h"></i> Other
                                </label>
                            </div>
                        </div>
                        <input type="text" class="form-control mt-2" id="otherNeeds" placeholder="Please specify other needs" style="display:none;" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="sendSOSBtn">
                    <i class="fas fa-paper-plane"></i> Send SOS
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mission & Vision Section -->
    <section class="section" id="mission">
        <div class="section-header">
            <h2>Our Mission & Vision</h2>
            <p>Guiding principles that drive our healthcare services</p>
        </div>
        <div class="mission-vision">
            <div class="vision-card">
                <h3><i class="fas fa-eye"></i> VISION</h3>
                <p>"As a Health Care Provider, the University of Cebu – Main goal is to render efficient Medical and Dental Services to the UC Community as a whole, and to promote good health and well-being of students that will highly contribute to their success."</p>
            </div>
            <div class="mission-card">
                <h3><i class="fas fa-bullseye"></i> MISSION</h3>
                <p>"Diverse implements, effective and accessible antidote for any malady and the health teaching that will be bestowed/ inculcated by the Clinicians to the minds of every individual who will be going to the Clinic are what the endeavor uses and does to ensure that the wellness of the health among UC populace is at hand."</p>
            </div>
        </div>
        <div class="staff-section">
            <h3 class="clinic-title">MEDICAL- DENTAL CLINIC</h3>
            <p class="clinic-description">"The UC Medical- Dental Clinic aims to promote good health and total well- being of the students, the teachers and the employees through prevention, diagnosis, treatment of disease, and education."</p>
        </div>
    </section>

    <!-- Staff Section -->
    <section class="section" id="staff">
        <div class="section-header">
            <h2>Our Medical & Dental Staff</h2>
            <p>Meet our dedicated healthcare professionals</p>
        </div>
        <div class="staff-section">
            <div class="staff-category">
                <h3>MEDICAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Carolyn Go- Uang</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Jewel Ann Marie Abella</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Hermogina Jao- Co</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 5:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Rosalinda Margallo</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>DENTAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Concepcion Tundag</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Cherryl Abineta- Asibal</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Emmanuel Mercado</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 1:00 PM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Frances Mae Licong</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>NURSING STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Mrs. Paz Colina Po, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Charlene Gallentes, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Lloyd Dabon, DMD, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 1:30 PM - 9:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Nancy Ong, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Ms. Therese Bacalso, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 10:30 AM - 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Objectives Section -->
    <section class="section" id="objectives">
        <div class="section-header">
            <h2>Department Objectives</h2>
            <p>Our commitment to comprehensive healthcare services</p>
        </div>
        <div class="objectives">
            <h3>DEPARTMENT OBJECTIVES:</h3>
            <ul class="objectives-list">
                <li>Provide preventive measures through BP taking and physical examination, oral examination and prophylaxis;</li>
                <li>Diagnose diseases based on the patient's history, clinical and laboratory findings;</li>
                <li>Give treatment to specific diseases based on diagnosis.</li>
                <li>Conduct Medical- Dental awareness and education through posters and counseling.</li>
            </ul>
        </div>
    </section>
</div>

@section Scripts {
    <script>
        let messagesInterval = null;

        $(document).ready(function() {
            initializeMessaging();
        });

        // Initialize messaging
        function initializeMessaging() {
            console.log('Initializing messaging...');
            
            // Load messages on page load
            loadMessages();

            // Auto-refresh messages every 10 seconds
            startMessagingAutoRefresh();

            // Send message button click
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessageToStaff);
            }

            // Send message on Enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessageToStaff();
                    }
                });
            }
        }

        // Load messages from server
        async function loadMessages() {
            try {
                const response = await fetch('/Home/GetMessages');
                const result = await response.json();

                if (result.success && result.data) {
                    displayMessages(result.data);
                } else {
                    console.error('Failed to load messages:', result.error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display messages in the chat
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="message received">
                        <div class="message-content">
                            Welcome to QuickClinique! How can we assist you today?
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(msg => {
                const messageClass = msg.isSent ? 'sent' : 'received';
                const messageTime = formatMessageTime(msg.createdAt);
                
                return `
                    <div class="message ${messageClass}">
                        <div class="message-content">${escapeHtml(msg.message)}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to clinic staff
        async function sendMessageToStaff() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText) {
                return;
            }

            // Disable send button
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/Home/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ message: messageText })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear input
                    messageInput.value = '';

                    // Reload messages
                    await loadMessages();
                } else {
                    alert('Failed to send message: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Format message timestamp
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hr ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start auto-refresh for messages
        function startMessagingAutoRefresh() {
            if (messagesInterval) {
                clearInterval(messagesInterval);
            }

            messagesInterval = setInterval(function() {
                loadMessages();
            }, 10000); // Refresh every 10 seconds
        }

        // Stop messaging auto-refresh
        function stopMessagingAutoRefresh() {
            if (messagesInterval) {
                clearInterval(messagesInterval);
                messagesInterval = null;
            }
        }

        // SOS Emergency functionality
        $('#needOther').on('change', function() {
            if ($(this).is(':checked')) {
                $('#otherNeeds').show().prop('required', true);
            } else {
                $('#otherNeeds').hide().prop('required', false).val('');
            }
        });

        $('#sosModal').on('hidden.bs.modal', function() {
            // Reset form when modal is closed
            $('#sosForm')[0].reset();
            $('input[name="needs"]').prop('checked', false);
            $('#otherNeeds').hide().val('');
        });

        $('#sendSOSBtn').on('click', async function() {
            const location = $('#emergencyLocation').val().trim();
            const selectedNeeds = $('input[name="needs"]:checked').map(function() {
                return $(this).val();
            }).get();
            const otherNeeds = $('#otherNeeds').val().trim();

            // Validation
            if (!location) {
                alert('Please enter your location');
                return;
            }

            if (selectedNeeds.length === 0) {
                alert('Please select at least one item you need');
                return;
            }

            // Build needs string
            let needsList = selectedNeeds;
            if (selectedNeeds.includes('Other') && otherNeeds) {
                needsList = selectedNeeds.filter(n => n !== 'Other');
                needsList.push(`Other: ${otherNeeds}`);
            }
            const needs = needsList.join(', ');

            // Disable button
            const sendBtn = $(this);
            sendBtn.prop('disabled', true);
            sendBtn.html('<i class="fas fa-spinner fa-spin"></i> Sending...');

            try {
                const response = await fetch('@Url.Action("SendSOS", "Student")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        location: location,
                        needs: needs
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('SOS Emergency request sent successfully! Clinic staff have been notified.');
                    $('#sosModal').modal('hide');
                } else {
                    alert('Failed to send SOS: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending SOS:', error);
                alert('Error sending SOS. Please try again.');
            } finally {
                sendBtn.prop('disabled', false);
                sendBtn.html('<i class="fas fa-paper-plane"></i> Send SOS');
            }
        });
    </script>
}