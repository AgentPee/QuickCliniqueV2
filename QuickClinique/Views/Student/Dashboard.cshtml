@model QuickClinique.Models.Student
@{
    ViewData["Title"] = "My Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
}

<div class="student-dashboard">
    <!-- Fixed SOS Emergency Button -->
    <button type="button" class="fixed-sos-btn sos-btn" data-bs-toggle="modal" data-bs-target="#sosModal">
        <i class="fas fa-exclamation-triangle"></i> SOS Emergency
    </button>
    
    <div class="dashboard-container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1><i class="fas fa-hand-wave"></i> Welcome, @Model.FirstName!</h1>
            <p>Here's an overview of your appointments and health information</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3 id="totalAppointments">0</h3>
                <p>Total Appointments</p>
            </div>

            <div class="stat-card success">
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 id="completedAppointments">0</h3>
                <p>Completed</p>
            </div>

            <div class="stat-card warning">
                <div class="icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 id="pendingAppointments">0</h3>
                <p>Pending</p>
            </div>

            <div class="stat-card info">
                <div class="icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h3 id="upcomingAppointments">0</h3>
                <p>Upcoming</p>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Clinic Communications Section -->
            <div class="appointments-section">
                <div class="section-header">
                    <h2><i class="fas fa-comments"></i> Clinic Communications</h2>
                    <button class="btn btn-sm btn-primary" onclick="loadMessages()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <div class="messaging-container messaging-container-mt">
                    <div class="chat-header chat-header-gradient">
                        <i class="fas fa-user-md"></i> Clinic Staff
                    </div>
                    <div class="chat-messages chat-messages-container" id="chatMessages">
                        <div class="message received">
                            <div class="message-content">
                                Welcome to QuickClinique! How can we assist you today?
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                    <div class="chat-input chat-input-flex">
                        <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500" class="chat-input-field">
                        <button class="btn btn-primary chat-send-btn" id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="quick-actions">
                <!-- Profile Card -->
                <div class="profile-card">
                    <h3><i class="fas fa-user-circle"></i> My Profile</h3>
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <i class="fas fa-id-card"></i>
                            <span>@Model.Idnumber</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-envelope"></i>
                            <span>@Model.Email</span>
                        </div>
                        <div class="profile-info-item">
                            <i class="fas fa-phone"></i>
                            <span>@Model.PhoneNumber</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <h4>
                    <i class="fas fa-bolt"></i> Quick Actions
                </h4>

                <a href="@Url.Action("Index", "Home")" class="action-btn">
                    <i class="fas fa-calendar-plus"></i> Set Appointment
                </a>

                <a href="@Url.Action("Profile", "Student")" class="action-btn secondary">
                    <i class="fas fa-user-edit"></i> Edit Profile
                </a>

                <a href="@Url.Action("History", "Student")" class="action-btn secondary">
                    <i class="fas fa-history"></i> View History
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Mission & Vision Section -->
    <section class="section" id="mission">
        <div class="section-header">
            <h2>Our Mission & Vision</h2>
            <p>Guiding principles that drive our healthcare services</p>
        </div>
        <div class="mission-vision">
            <div class="vision-card">
                <h3><i class="fas fa-eye"></i> VISION</h3>
                <p>"As a Health Care Provider, the University of Cebu – Main goal is to render efficient Medical and Dental Services to the UC Community as a whole, and to promote good health and well-being of students that will highly contribute to their success."</p>
            </div>
            <div class="mission-card">
                <h3><i class="fas fa-bullseye"></i> MISSION</h3>
                <p>"Diverse implements, effective and accessible antidote for any malady and the health teaching that will be bestowed/ inculcated by the Clinicians to the minds of every individual who will be going to the Clinic are what the endeavor uses and does to ensure that the wellness of the health among UC populace is at hand."</p>
            </div>
        </div>
        <div class="staff-section">
            <h3 class="clinic-title">MEDICAL- DENTAL CLINIC</h3>
            <p class="clinic-description">"The UC Medical- Dental Clinic aims to promote good health and total well- being of the students, the teachers and the employees through prevention, diagnosis, treatment of disease, and education."</p>
        </div>
    </section>

    <!-- Staff Section -->
    <section class="section" id="staff">
        <div class="section-header">
            <h2>Our Medical & Dental Staff</h2>
            <p>Meet our dedicated healthcare professionals</p>
        </div>
        <div class="staff-section">
            <div class="staff-category">
                <h3>MEDICAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Carolyn Go- Uang</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Jewel Ann Marie Abella</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 8:00 AM – 12:00 NN (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Hermogina Jao- Co</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 5:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Rosalinda Margallo</h4>
                        <p>Medical Doctor</p>
                        <div class="staff-schedule">Schedule: 1:30 PM – 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>DENTAL STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Dr. Concepcion Tundag</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 12:00 NN</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Cherryl Abineta- Asibal</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Emmanuel Mercado</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 1:00 PM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Frances Mae Licong</h4>
                        <p>Dentist</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                </div>
            </div>

            <div class="staff-category">
                <h3>NURSING STAFF</h3>
                <div class="staff-grid">
                    <div class="staff-card">
                        <h4>Mrs. Paz Colina Po, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (High School/ Grade School)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Charlene Gallentes, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Dr. Lloyd Dabon, DMD, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 1:30 PM - 9:30 PM</div>
                    </div>
                    <div class="staff-card">
                        <h4>Mrs. Nancy Ong, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 8:00 AM - 5:00 PM (South Campus- Extension Clinic)</div>
                    </div>
                    <div class="staff-card">
                        <h4>Ms. Therese Bacalso, BSN, RN</h4>
                        <p>Nurse</p>
                        <div class="staff-schedule">Schedule: 10:30 AM - 7:30 PM (South Campus- Extension Clinic)</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Objectives Section -->
    <section class="section" id="objectives">
        <div class="section-header">
            <h2>Department Objectives</h2>
            <p>Our commitment to comprehensive healthcare services</p>
        </div>
        <div class="objectives">
            <h3>DEPARTMENT OBJECTIVES:</h3>
            <ul class="objectives-list">
                <li>Provide preventive measures through BP taking and physical examination, oral examination and prophylaxis;</li>
                <li>Diagnose diseases based on the patient's history, clinical and laboratory findings;</li>
                <li>Give treatment to specific diseases based on diagnosis.</li>
                <li>Conduct Medical- Dental awareness and education through posters and counseling.</li>
            </ul>
        </div>
    </section>
</div>

<!-- SOS Emergency Modal -->
<div class="modal fade" id="sosModal" tabindex="-1" aria-labelledby="sosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="sosModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> SOS Emergency Request
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> <strong>Emergency Alert:</strong> This will notify clinic staff immediately. Use only for genuine emergencies.
                </div>

                <form id="sosForm">
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Student Name</label>
                        <input type="text" class="form-control" id="studentName" value="@Model.FirstName @Model.LastName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="studentIdNumber" class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="studentIdNumber" value="@Model.Idnumber" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="sosLocation" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sosLocation" placeholder="e.g., Building A, Room 201" required>
                        <small class="form-text text-muted">Where are you located?</small>
                        <div class="invalid-feedback" id="locationError"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label sos-needs-label">
                            <i class="fas fa-tools"></i> Needs <span class="text-danger">*</span>
                        </label>
                        <div class="sos-needs-options">
                            <div class="form-check sos-need-option" data-value="First Aid Kit">
                                <input class="form-check-input" type="checkbox" id="needFirstAid" value="First Aid Kit">
                                <label class="form-check-label" for="needFirstAid">
                                    <div class="sos-option-icon">
                                        <i class="fas fa-first-aid"></i>
                                    </div>
                                    <div class="sos-option-content">
                                        <div class="sos-option-title">First Aid Kit</div>
                                        <div class="sos-option-description">Medical supplies and bandages</div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check sos-need-option" data-value="Wheelchair">
                                <input class="form-check-input" type="checkbox" id="needWheelchair" value="Wheelchair">
                                <label class="form-check-label" for="needWheelchair">
                                    <div class="sos-option-icon">
                                        <i class="fas fa-wheelchair"></i>
                                    </div>
                                    <div class="sos-option-content">
                                        <div class="sos-option-title">Wheelchair</div>
                                        <div class="sos-option-description">Mobility assistance needed</div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check sos-need-option" data-value="Stretcher">
                                <input class="form-check-input" type="checkbox" id="needStretcher" value="Stretcher">
                                <label class="form-check-label" for="needStretcher">
                                    <div class="sos-option-icon">
                                        <i class="fas fa-bed"></i>
                                    </div>
                                    <div class="sos-option-content">
                                        <div class="sos-option-title">Stretcher</div>
                                        <div class="sos-option-description">Patient transport required</div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check sos-need-option" data-value="Other">
                                <input class="form-check-input" type="checkbox" id="needOther" value="Other">
                                <label class="form-check-label" for="needOther">
                                    <div class="sos-option-icon">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </div>
                                    <div class="sos-option-content">
                                        <div class="sos-option-title">Other</div>
                                        <div class="sos-option-description">Specify additional needs</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div id="otherInputContainer" class="sos-other-input-container hidden">
                            <input type="text" class="form-control" id="otherInput" placeholder="Please specify...">
                        </div>
                        <div class="invalid-feedback" id="needsError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="sendSOSBtn">
                    <i class="fas fa-paper-plane"></i> Send SOS
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Help is on the Way Modal -->
<div class="modal fade" id="helpOnTheWayModal" tabindex="-1" aria-labelledby="helpOnTheWayModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content help-on-the-way-modal-content">
            <div class="modal-header help-on-the-way-header">
                <h5 class="modal-title" id="helpOnTheWayModalLabel">
                    <i class="fas fa-check-circle"></i> Help is on the Way!
                </h5>
            </div>
            <div class="modal-body help-on-the-way-body">
                <div class="help-message-container">
                    <div class="help-icon-wrapper">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <h3 class="help-title">Your SOS Alert Has Been Received</h3>
                    <p class="help-message">
                        Clinic staff has acknowledged your emergency request and help is on the way. 
                        Please stay where you are and wait for assistance.
                    </p>
                    <div class="help-info-box">
                        <i class="fas fa-info-circle"></i>
                        <span>Stay calm and wait for clinic staff to arrive at your location.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer help-on-the-way-footer">
                <button type="button" class="btn btn-primary help-confirm-btn" id="acknowledgeHelpBtn">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Follow-up Reminder Modal -->
<div class="modal fade" id="followUpReminderModal" tabindex="-1" aria-labelledby="followUpReminderModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content follow-up-modal-content">
            <div class="modal-header follow-up-header">
                <h5 class="modal-title" id="followUpReminderModalLabel">
                    <i class="fas fa-clock"></i> Follow-up Reminder
                </h5>
            </div>
            <div class="modal-body follow-up-body">
                <div class="follow-up-message-container">
                    <div class="follow-up-icon-wrapper">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <h3 class="follow-up-title">Do you still need assistance?</h3>
                    <p class="follow-up-message">
                        It's been 1 minute since clinic staff responded to your emergency request. 
                        Please let us know if you still need help or if assistance has arrived.
                    </p>
                    <div class="follow-up-info-box">
                        <i class="fas fa-info-circle"></i>
                        <span>Choose an option below to continue.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer follow-up-footer">
                <button type="button" class="btn btn-warning follow-up-follow-btn" id="followUpBtn">
                    <i class="fas fa-redo"></i> Follow Up (Re-send Emergency)
                </button>
                <button type="button" class="btn btn-success follow-up-received-btn" id="helpReceivedBtn">
                    <i class="fas fa-check-circle"></i> Help is Received
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        let connection = null;
        let currentUserId = null;
        let emergencyCheckInterval = null;
        let lastCheckedEmergencyId = null;
        let helpModalShown = false;
        let followUpTimer = null;
        let currentEmergencyIdForFollowUp = null;
        let lastSOSData = null;

        $(document).ready(function() {
            initializeMessaging();
            loadDashboardStatistics();
            initializeSOSButton();
            
            // Also initialize SOS button when modal is shown (in case it's opened dynamically)
            const sosModalElement = document.getElementById('sosModal');
            if (sosModalElement) {
                sosModalElement.addEventListener('shown.bs.modal', function() {
                    setTimeout(() => {
                        initializeSOSButton();
                    }, 50);
                });
            }
        });

        // Initialize SOS button with proper event handling
        function initializeSOSButton() {
            const sendSOSBtn = document.getElementById('sendSOSBtn');
            if (!sendSOSBtn) {
                console.error('Send SOS button not found');
                return;
            }

            // Remove existing event listeners by cloning and replacing
            const newBtn = sendSOSBtn.cloneNode(true);
            sendSOSBtn.parentNode.replaceChild(newBtn, sendSOSBtn);

            // Attach event listener to the new button
            document.getElementById('sendSOSBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const location = document.getElementById('sosLocation').value.trim();
                const needs = [];
                
                if (document.getElementById('needFirstAid').checked) {
                    needs.push('First Aid Kit');
                }
                if (document.getElementById('needWheelchair').checked) {
                    needs.push('Wheelchair');
                }
                if (document.getElementById('needStretcher').checked) {
                    needs.push('Stretcher');
                }
                if (document.getElementById('needOther').checked) {
                    const otherValue = document.getElementById('otherInput').value.trim();
                    if (otherValue) {
                        needs.push('Other: ' + otherValue);
                    } else {
                        needs.push('Other');
                    }
                }

                // Validation
                let isValid = true;
                document.getElementById('locationError').textContent = '';
                document.getElementById('needsError').textContent = '';
                
                if (!location) {
                    document.getElementById('locationError').textContent = 'Location is required';
                    document.getElementById('sosLocation').classList.add('is-invalid');
                    isValid = false;
                } else {
                    document.getElementById('sosLocation').classList.remove('is-invalid');
                }

                if (needs.length === 0) {
                    const needsError = document.getElementById('needsError');
                    needsError.textContent = 'Please select at least one need';
                    needsError.style.display = 'block';
                    document.querySelectorAll('.sos-need-option').forEach(el => {
                        el.classList.add('error-state');
                    });
                    isValid = false;
                } else {
                    document.getElementById('needsError').style.display = 'none';
                    document.querySelectorAll('.sos-need-option').forEach(el => {
                        el.classList.remove('error-state');
                    });
                }

                if (!isValid) {
                    return;
                }

                // Disable button and show loading
                const btn = this;
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                try {
                    const response = await fetch('/Student/SendSOS', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            location: location,
                            needs: needs.join(', ')
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        // Store the SOS data for follow-up resending
                        lastSOSData = {
                            location: location,
                            needs: needs.join(', ')
                        };
                        
                        alert('SOS emergency request sent successfully! Clinic staff has been notified.');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('sosModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // Reset form
                        const sosForm = document.getElementById('sosForm');
                        if (sosForm) {
                            sosForm.reset();
                        }
                        const otherContainer = document.getElementById('otherInputContainer');
                        if (otherContainer) {
                            otherContainer.classList.add('hidden');
                        }
                        
                        // Reset help modal flag so it can show when resolved
                        helpModalShown = false;
                        lastCheckedEmergencyId = result.emergencyId;
                    } else {
                        alert('Failed to send SOS: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error sending SOS:', error);
                    alert('Error sending SOS: ' + (error.message || 'Please try again.'));
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            });
        }

        // Initialize messaging with SignalR
        async function initializeMessaging() {
            console.log('Initializing messaging with SignalR...');
            
            // First, get current user ID and load initial messages
            await loadMessages();
            
            // Initialize SignalR connection
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/messageHub")
                .withAutomaticReconnect()
                .build();

            // Handle incoming messages
            connection.on("ReceiveMessage", function (message) {
                console.log('Received message via SignalR:', message);
                addMessageToChat(message);
            });

            // Handle emergency acknowledgment from staff (real-time notification)
            connection.on("EmergencyAcknowledged", function (data) {
                console.log('Emergency acknowledged via SignalR:', data);
                if (data && data.emergencyId) {
                    const acknowledgedId = data.emergencyId;
                    // Show "Help is on the Way" modal immediately
                    // Allow showing again even if previously acknowledged (for resend scenarios)
                    if (!helpModalShown || lastCheckedEmergencyId !== acknowledgedId) {
                        // Clear any existing modal instance
                        const modalElement = document.getElementById('helpOnTheWayModal');
                        if (modalElement) {
                            const existingModal = bootstrap.Modal.getInstance(modalElement);
                            if (existingModal) {
                                existingModal.hide();
                            }
                        }
                        
                        showHelpOnTheWayModal(acknowledgedId);
                        helpModalShown = true;
                        lastCheckedEmergencyId = acknowledgedId;
                    }
                }
            });

            // Handle connection events
            connection.onreconnecting(() => {
                console.log('SignalR reconnecting...');
            });

            connection.onreconnected(async () => {
                console.log('SignalR reconnected');
                // Rejoin user group and emergency group after reconnection
                if (currentUserId) {
                    await connection.invoke("JoinUserGroup", currentUserId).catch(err => console.error(err));
                }
                // Rejoin emergency group
                try {
                    const studentIdResponse = await fetch('/Student/GetCurrentStudentId');
                    if (studentIdResponse.ok) {
                        const studentIdResult = await studentIdResponse.json();
                        if (studentIdResult.success && studentIdResult.studentId) {
                            await connection.invoke("JoinEmergencyGroup", studentIdResult.studentId).catch(err => console.error(err));
                        }
                    }
                } catch (err) {
                    console.error('Error rejoining emergency group:', err);
                }
            });

            connection.onclose(() => {
                console.log('SignalR connection closed');
            });

            // Start connection
            try {
                await connection.start();
                console.log('SignalR connected');

                // Join user group after connection is established
                if (currentUserId) {
                    await connection.invoke("JoinUserGroup", currentUserId);
                    console.log('Joined user group:', currentUserId);
                }

                // Join emergency notification group for real-time emergency updates
                // Get student ID from the loadMessages function or fetch it
                try {
                    const studentIdResponse = await fetch('/Student/GetCurrentStudentId');
                    if (studentIdResponse.ok) {
                        const studentIdResult = await studentIdResponse.json();
                        if (studentIdResult.success && studentIdResult.studentId) {
                            await connection.invoke("JoinEmergencyGroup", studentIdResult.studentId);
                            console.log('Joined emergency group for student:', studentIdResult.studentId);
                        }
                    }
                } catch (err) {
                    console.error('Error getting student ID for emergency group:', err);
                }
            } catch (err) {
                console.error('Error starting SignalR connection:', err);
                // Fallback to polling if SignalR fails
                startMessagingAutoRefresh();
            }

            // Send message button click
            const sendButton = document.getElementById('sendMessage');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessageToStaff);
            }

            // Send message on Enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessageToStaff();
                    }
                });
            }
        }

        // Load messages from server
        async function loadMessages() {
            try {
                const response = await fetch('/Home/GetMessages');
                const result = await response.json();

                if (result.success && result.data) {
                    currentUserId = result.currentUserId;
                    displayMessages(result.data);
                } else {
                    console.error('Failed to load messages:', result.error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Add a single message to the chat (for real-time updates)
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Check if message already exists (prevent duplicates)
            const existingMessage = chatMessages.querySelector(`[data-message-id="${message.messageId}"]`);
            if (existingMessage) {
                return;
            }

            const messageClass = message.isSent ? 'sent' : 'received';
            const messageTime = formatMessageTime(message.createdAt);
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${messageClass}`;
            messageElement.setAttribute('data-message-id', message.messageId);
            messageElement.innerHTML = `
                <div class="message-content">${escapeHtml(message.message)}</div>
                <div class="message-time">${messageTime}</div>
            `;

            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Display messages in the chat
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="message received">
                        <div class="message-content">
                            Welcome to QuickClinique! How can we assist you today?
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                `;
                return;
            }

            chatMessages.innerHTML = messages.map(msg => {
                const messageClass = msg.isSent ? 'sent' : 'received';
                const messageTime = formatMessageTime(msg.createdAt);
                
                return `
                    <div class="message ${messageClass}">
                        <div class="message-content">${escapeHtml(msg.message)}</div>
                        <div class="message-time">${messageTime}</div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message to clinic staff
        async function sendMessageToStaff() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();

            if (!messageText) {
                return;
            }

            // Disable send button
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/Home/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ message: messageText })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear input
                    messageInput.value = '';

                    // Message will be added via SignalR, but we can also add it immediately for better UX
                    if (result.data) {
                        addMessageToChat(result.data);
                    }
                } else {
                    alert('Failed to send message: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Format message timestamp
        function formatMessageTime(timestamp) {
            // Ensure timestamp is treated as UTC if it doesn't have timezone info
            let date;
            if (typeof timestamp === 'string') {
                // If timestamp doesn't end with Z or have timezone, assume it's UTC
                if (!timestamp.endsWith('Z') && !timestamp.includes('+') && !timestamp.includes('-', 10)) {
                    // Add Z to indicate UTC if not present
                    date = new Date(timestamp + (timestamp.includes('T') ? 'Z' : ''));
                } else {
                    date = new Date(timestamp);
                }
            } else {
                date = new Date(timestamp);
            }
            
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            // Handle negative differences (future dates) or very small differences
            if (diffMs < 0 || diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins} min ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hr ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fallback: Start auto-refresh for messages (only used if SignalR fails)
        function startMessagingAutoRefresh() {
            console.log('Using polling fallback for messages');
            return setInterval(function() {
                loadMessages();
            }, 10000); // Refresh every 10 seconds
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (connection) {
                connection.stop();
            }
        });

        // ===== DASHBOARD STATISTICS =====
        // Load dashboard statistics (appointment counts)
        async function loadDashboardStatistics() {
            try {
                const response = await fetch('/Student/GetDashboardStatistics');
                const result = await response.json();

                if (result.success && result.data) {
                    // Update the statistics cards
                    document.getElementById('totalAppointments').textContent = result.data.totalAppointments || 0;
                    document.getElementById('completedAppointments').textContent = result.data.completedAppointments || 0;
                    document.getElementById('pendingAppointments').textContent = result.data.pendingAppointments || 0;
                    document.getElementById('upcomingAppointments').textContent = result.data.upcomingAppointments || 0;
                } else {
                    console.error('Failed to load dashboard statistics:', result.error);
                    // Keep default values (0) if loading fails
                }
            } catch (error) {
                console.error('Error loading dashboard statistics:', error);
                // Keep default values (0) if loading fails
            }
        }
    </script>

    <script>
        // Show/hide other input based on checkbox
        document.getElementById('needOther').addEventListener('change', function() {
            const otherContainer = document.getElementById('otherInputContainer');
            if (this.checked) {
                otherContainer.classList.remove('hidden');
            } else {
                otherContainer.classList.add('hidden');
                document.getElementById('otherInput').value = '';
            }
        });

        // Add selection styling for checkboxes - remove error state when any is selected
        document.addEventListener('DOMContentLoaded', function() {
            const needOptions = document.querySelectorAll('.sos-need-option');
            needOptions.forEach(option => {
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        // Remove error state when any option is selected
                        if (this.checked) {
                            const needsError = document.getElementById('needsError');
                            needsError.style.display = 'none';
                            needOptions.forEach(opt => {
                                opt.classList.remove('error-state');
                            });
                        }
                    });
                }
            });
        });

        // Handle SOS form submission
        document.getElementById('sendSOSBtn').addEventListener('click', async function() {
            const location = document.getElementById('sosLocation').value.trim();
            const needs = [];
            
            if (document.getElementById('needFirstAid').checked) {
                needs.push('First Aid Kit');
            }
            if (document.getElementById('needWheelchair').checked) {
                needs.push('Wheelchair');
            }
            if (document.getElementById('needStretcher').checked) {
                needs.push('Stretcher');
            }
            if (document.getElementById('needOther').checked) {
                const otherValue = document.getElementById('otherInput').value.trim();
                if (otherValue) {
                    needs.push('Other: ' + otherValue);
                } else {
                    needs.push('Other');
                }
            }

            // Validation
            let isValid = true;
            document.getElementById('locationError').textContent = '';
            document.getElementById('needsError').textContent = '';
            
            if (!location) {
                document.getElementById('locationError').textContent = 'Location is required';
                document.getElementById('sosLocation').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('sosLocation').classList.remove('is-invalid');
            }

            if (needs.length === 0) {
                const needsError = document.getElementById('needsError');
                needsError.textContent = 'Please select at least one need';
                needsError.style.display = 'block';
                // Add error state to all options
                document.querySelectorAll('.sos-need-option').forEach(el => {
                    el.classList.add('error-state');
                });
                isValid = false;
            } else {
                // Remove error state if needs are selected
                document.getElementById('needsError').style.display = 'none';
                document.querySelectorAll('.sos-need-option').forEach(el => {
                    el.classList.remove('error-state');
                });
            }

            if (!isValid) {
                return;
            }

            // Disable button and show loading
            const btn = this;
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('/Student/SendSOS', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        location: location,
                        needs: needs.join(', ')
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Store the SOS data for follow-up resending
                    lastSOSData = {
                        location: location,
                        needs: needs.join(', ')
                    };
                    
                    alert('SOS emergency request sent successfully! Clinic staff has been notified.');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sosModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('sosForm').reset();
                    document.getElementById('otherInputContainer').classList.add('hidden');
                    
                    // Reset help modal flag so it can show when resolved
                    helpModalShown = false;
                    lastCheckedEmergencyId = result.emergencyId;
                } else {
                    alert('Failed to send SOS: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending SOS:', error);
                alert('Error sending SOS: ' + (error.message || 'Please try again.'));
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });

        // ===== EMERGENCY RESOLVED CHECK POLLING =====
        // Helper functions for localStorage
        function getAcknowledgedEmergencyIds() {
            try {
                const stored = localStorage.getItem('acknowledgedEmergencyIds');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        function addAcknowledgedEmergencyId(emergencyId) {
            try {
                const acknowledged = getAcknowledgedEmergencyIds();
                if (!acknowledged.includes(emergencyId)) {
                    acknowledged.push(emergencyId);
                    localStorage.setItem('acknowledgedEmergencyIds', JSON.stringify(acknowledged));
                }
            } catch (e) {
                console.error('Error storing acknowledged emergency ID:', e);
            }
        }

        function isEmergencyAcknowledged(emergencyId) {
            if (!emergencyId) return false;
            const acknowledged = getAcknowledgedEmergencyIds();
            return acknowledged.includes(emergencyId);
        }

        function startEmergencyResolvedCheck() {
            if (emergencyCheckInterval) {
                clearInterval(emergencyCheckInterval);
            }

            // Use SignalR for real-time updates, but keep polling as fallback
            // Check less frequently (every 10 seconds) since SignalR handles real-time
            emergencyCheckInterval = setInterval(async () => {
                await checkIfEmergencyResolved();
            }, 10000); // Check every 10 seconds as fallback

            // Check immediately on page load
            checkIfEmergencyResolved();
        }

        async function checkIfEmergencyResolved() {
            try {
                const response = await fetch('/Student/CheckEmergencyResolved');
                if (!response.ok) {
                    console.error('Failed to check emergency status:', response.status);
                    return;
                }
                
                const result = await response.json();

                if (result.success && result.resolved) {
                    // Emergency was resolved - show modal only if we haven't acknowledged it yet
                    if (result.emergencyId && !isEmergencyAcknowledged(result.emergencyId)) {
                        // Show modal if this is a different emergency, or if we haven't shown it yet for this emergency
                        if (result.emergencyId !== lastCheckedEmergencyId || !helpModalShown) {
                            showHelpOnTheWayModal(result.emergencyId);
                            helpModalShown = true;
                            lastCheckedEmergencyId = result.emergencyId;
                        }
                    }
                } else if (result.success && !result.resolved) {
                    // No resolved emergency - reset flag if we have a new unresolved emergency
                    if (result.emergencyId && result.emergencyId !== lastCheckedEmergencyId) {
                        helpModalShown = false;
                        lastCheckedEmergencyId = result.emergencyId;
                    } else if (!result.emergencyId) {
                        // No active emergency at all - reset tracking
                        helpModalShown = false;
                        lastCheckedEmergencyId = null;
                    }
                }
            } catch (error) {
                console.error('Error checking emergency status:', error);
            }
        }

        function showHelpOnTheWayModal(emergencyId) {
            const modalElement = document.getElementById('helpOnTheWayModal');
            if (!modalElement) {
                console.error('Help on the way modal element not found');
                return;
            }

            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
            }

            modal.show();

            // Handle acknowledge button
            const acknowledgeBtn = document.getElementById('acknowledgeHelpBtn');
            if (acknowledgeBtn) {
                acknowledgeBtn.onclick = function() {
                    // Mark this emergency as acknowledged in localStorage
                    if (emergencyId) {
                        addAcknowledgedEmergencyId(emergencyId);
                        currentEmergencyIdForFollowUp = emergencyId;
                        
                        // Store the confirmation time for follow-up reminder
                        try {
                            const followUpData = {
                                emergencyId: emergencyId,
                                confirmedAt: new Date().toISOString()
                            };
                            localStorage.setItem('followUpReminder', JSON.stringify(followUpData));
                        } catch (e) {
                            console.error('Error storing follow-up reminder:', e);
                        }
                    }
                    modal.hide();
                    helpModalShown = true; // Keep flag true so it doesn't show again
                    
                    // Set timer for 1 minute to show follow-up reminder
                    if (followUpTimer) {
                        clearTimeout(followUpTimer);
                    }
                    followUpTimer = setTimeout(function() {
                        checkAndShowFollowUpReminder();
                    }, 1 * 60 * 1000); // 1 minute
                };
            }
        }

        // Check for follow-up reminder on page load (only if emergency is still active)
        async function checkAndShowFollowUpReminder() {
            try {
                const followUpDataStr = localStorage.getItem('followUpReminder');
                if (!followUpDataStr) return;
                
                const followUpData = JSON.parse(followUpDataStr);
                if (!followUpData.emergencyId || !followUpData.confirmedAt) return;

                // Verify the emergency is still active (not resolved) before showing follow-up
                try {
                    const response = await fetch('/Student/CheckEmergencyResolved');
                    if (response.ok) {
                        const result = await response.json();
                        // If emergency is resolved, clear the follow-up reminder
                        if (result.success && result.resolved) {
                            // Emergency is resolved, clear the reminder
                            localStorage.removeItem('followUpReminder');
                            localStorage.setItem(`followUpHandled_${followUpData.emergencyId}`, 'true');
                            return;
                        }
                        // If no active emergency at all, clear the reminder
                        if (result.success && !result.resolved && !result.emergencyId) {
                            localStorage.removeItem('followUpReminder');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error verifying emergency status:', error);
                    // Continue with follow-up check even if verification fails
                }
                
                const confirmedAt = new Date(followUpData.confirmedAt);
                const now = new Date();
                const minutesSinceConfirmed = (now - confirmedAt) / (1000 * 60);
                
                // Check if 1 minute has passed
                if (minutesSinceConfirmed >= 1) {
                    // Check if we've already shown or handled this follow-up
                    const handledFollowUp = localStorage.getItem(`followUpHandled_${followUpData.emergencyId}`);
                    if (!handledFollowUp) {
                        showFollowUpReminderModal(followUpData.emergencyId);
                    }
                } else {
                    // Set timer to show modal when 1 minute has passed
                    const remainingMs = (1 * 60 * 1000) - (now - confirmedAt);
                    if (remainingMs > 0) {
                        if (followUpTimer) {
                            clearTimeout(followUpTimer);
                        }
                        followUpTimer = setTimeout(async function() {
                            // Verify emergency is still active before showing
                            try {
                                const checkResponse = await fetch('/Student/CheckEmergencyResolved');
                                if (checkResponse.ok) {
                                    const checkResult = await checkResponse.json();
                                    if (checkResult.success && checkResult.resolved) {
                                        // Emergency is resolved, don't show follow-up
                                        localStorage.removeItem('followUpReminder');
                                        localStorage.setItem(`followUpHandled_${followUpData.emergencyId}`, 'true');
                                        return;
                                    }
                                }
                            } catch (e) {
                                console.error('Error verifying emergency in timer:', e);
                            }
                            
                            const handledFollowUp = localStorage.getItem(`followUpHandled_${followUpData.emergencyId}`);
                            if (!handledFollowUp) {
                                showFollowUpReminderModal(followUpData.emergencyId);
                            }
                        }, remainingMs);
                    }
                }
            } catch (e) {
                console.error('Error checking follow-up reminder:', e);
            }
        }

        // Show follow-up reminder modal
        function showFollowUpReminderModal(emergencyId) {
            const modalElement = document.getElementById('followUpReminderModal');
            if (!modalElement) {
                console.error('Follow-up reminder modal element not found');
                return;
            }

            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
            }

            // Reset button states before showing modal
            const followUpBtn = document.getElementById('followUpBtn');
            const helpReceivedBtn = document.getElementById('helpReceivedBtn');
            
            if (followUpBtn) {
                // Reset button to original state - ensure it's fully functional
                followUpBtn.disabled = false;
                followUpBtn.innerHTML = '<i class="fas fa-redo"></i> Follow Up (Re-send Emergency)';
                // Remove all existing event listeners by replacing onclick
                followUpBtn.onclick = null;
            }
            
            if (helpReceivedBtn) {
                // Reset button to original state
                helpReceivedBtn.disabled = false;
                helpReceivedBtn.innerHTML = '<i class="fas fa-check-circle"></i> Help is Received';
            }

            // Show modal first, then attach handlers after a small delay to ensure DOM is ready
            modal.show();
            
            // Use setTimeout to ensure modal is fully shown and button state is reset before attaching handlers
            setTimeout(() => {
                // Re-get button references after modal is shown (in case DOM was refreshed)
                const followUpBtnRefreshed = document.getElementById('followUpBtn');
                const helpReceivedBtnRefreshed = document.getElementById('helpReceivedBtn');
                
                // Handle Follow Up button - re-send the emergency (uses existing emergency ID)
                if (followUpBtnRefreshed) {
                    // Ensure button is in correct state
                    followUpBtnRefreshed.disabled = false;
                    followUpBtnRefreshed.innerHTML = '<i class="fas fa-redo"></i> Follow Up (Re-send Emergency)';
                    followUpBtnRefreshed.onclick = null; // Clear any existing handler
                    
                    followUpBtnRefreshed.onclick = async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const btn = this;
                        // Prevent double-click
                        if (btn.disabled) {
                            return;
                        }
                        
                        btn.disabled = true;
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resending...';
                        
                        try {
                            if (!emergencyId) {
                                alert('Emergency ID not found. Please send a new SOS request.');
                                btn.disabled = false;
                                btn.innerHTML = originalHtml;
                                return;
                            }

                            // Resend using existing emergency ID (doesn't create new one)
                            const response = await fetch('/Student/ResendSOS', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    emergencyId: emergencyId
                                })
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();

                            if (result.success) {
                                modal.hide();
                                
                                // Reset button state immediately after successful resend
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fas fa-redo"></i> Follow Up (Re-send Emergency)';
                                
                                // Clear follow-up tracking so the flow can work again
                                localStorage.removeItem(`followUpHandled_${emergencyId}`);
                                localStorage.removeItem('followUpReminder');
                                
                                // Clear existing follow-up timer
                                if (followUpTimer) {
                                    clearTimeout(followUpTimer);
                                    followUpTimer = null;
                                }
                                
                                // Reset modal tracking flags so "Help is on the Way" can show again when staff responds
                                helpModalShown = false;
                                
                                // Remove from acknowledged list so SignalR can trigger modal again
                                try {
                                    const acknowledged = getAcknowledgedEmergencyIds();
                                    const index = acknowledged.indexOf(emergencyId);
                                    if (index > -1) {
                                        acknowledged.splice(index, 1);
                                        localStorage.setItem('acknowledgedEmergencyIds', JSON.stringify(acknowledged));
                                    }
                                } catch (e) {
                                    console.error('Error clearing acknowledged emergency:', e);
                                }
                                
                                alert('SOS emergency request resent successfully! Clinic staff has been notified. You will be notified when they respond.');
                                // Don't reload - keep SignalR connection active for real-time updates
                            } else {
                                alert('Failed to resend SOS: ' + (result.error || 'Unknown error'));
                                btn.disabled = false;
                                btn.innerHTML = originalHtml;
                            }
                        } catch (error) {
                            console.error('Error resending SOS:', error);
                            alert('Error resending SOS: ' + (error.message || 'Please try again.'));
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }
                    };
                }

                // Handle Help is Received button
                if (helpReceivedBtnRefreshed) {
                    // Store reference to avoid issues
                    const btnElement = helpReceivedBtnRefreshed;
                    
                    // Remove existing onclick to prevent duplicates
                    btnElement.onclick = null;
                    // Remove existing listeners by replacing the element
                    btnElement.removeEventListener('click', arguments.callee);
                    
                    btnElement.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const btn = this;
                        btn.disabled = true;
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                        try {
                            // Ensure emergencyId is a number, but allow 0 to trigger "find most recent" logic
                            const emergencyIdNum = emergencyId ? parseInt(emergencyId) : 0;
                            
                            console.log('Sending MarkHelpReceived request for emergency ID:', emergencyIdNum || 'will use most recent');

                            const response = await fetch('/Student/MarkHelpReceived', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({ emergencyId: emergencyIdNum || 0 })
                            });

                            // Check if response is ok
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();

                        if (result && result.success) {
                            console.log('Successfully marked help as received. Emergency ID:', result.emergencyId || emergencyId);
                            modal.hide();
                            // Mark as handled - use the emergencyId from result if available
                            const finalEmergencyId = result.emergencyId || emergencyId;
                            if (finalEmergencyId) {
                                localStorage.setItem(`followUpHandled_${finalEmergencyId}`, 'true');
                            }
                            localStorage.removeItem('followUpReminder');
                            alert('Thank you for confirming! The emergency has been automatically marked as resolved.');
                            // Reload page
                            window.location.reload();
                        } else {
                            // Handle error message - check if it's an object or string
                            let errorMsg = 'Unknown error';
                            if (result && result.error) {
                                if (typeof result.error === 'string') {
                                    errorMsg = result.error;
                                } else if (result.error.message) {
                                    errorMsg = result.error.message;
                                } else {
                                    errorMsg = JSON.stringify(result.error);
                                }
                            }
                            alert('Failed to mark help as received: ' + errorMsg);
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }
                    } catch (error) {
                        console.error('Error marking help as received:', error);
                        const errorMessage = error.message || 'Please try again.';
                            alert('Error marking help as received: ' + errorMessage);
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }
                    });
                } else {
                    console.error('Help Received button not found in DOM');
                }
            }, 100); // Small delay to ensure modal DOM is ready
        }

        // Initialize emergency resolved check when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                startEmergencyResolvedCheck();
                // Only check follow-up reminder after emergency check is initialized
                // This prevents showing follow-up for resolved emergencies
                setTimeout(() => {
                    checkAndShowFollowUpReminder();
                }, 1500); // Small delay to ensure emergency check runs first
            });
        } else {
            startEmergencyResolvedCheck();
            // Only check follow-up reminder after emergency check is initialized
            setTimeout(() => {
                checkAndShowFollowUpReminder();
            }, 1500); // Small delay to ensure emergency check runs first
        }
    </script>

    <style>
        /* Fixed SOS Emergency Button */
        .fixed-sos-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 1rem 1.5rem;
            font-weight: 700;
            font-size: 1rem;
            border-radius: 50px;
            border: none;
            color: white;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .fixed-sos-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(220, 53, 69, 0.8);
        }

        .fixed-sos-btn i {
            font-size: 1.2rem;
        }

        @@media (max-width: 768px) {
            .fixed-sos-btn {
                top: 10px;
                right: 10px;
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .fixed-sos-btn i {
                font-size: 1rem;
            }
        }

        @@media (max-width: 576px) {
            .fixed-sos-btn {
                padding: 0.65rem 1rem;
                font-size: 0.85rem;
            }
        }

        /* SOS Needs Options - Enhanced Card Design */
        .sos-needs-label {
            font-weight: 600;
            color: #2D3748;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .sos-needs-label i {
            color: #dc3545;
            font-size: 1rem;
        }

        .sos-needs-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .sos-need-option {
            position: relative;
            padding: 0;
            margin: 0;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            overflow: hidden;
        }

        .sos-need-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            transition: all 0.3s ease;
        }

        .sos-need-option:hover {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
        }

        .sos-need-option:hover::before {
            background: #dc3545;
        }

        .sos-need-option:has(input[type="checkbox"]:checked) {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            box-shadow: 0 4px 16px rgba(220, 53, 69, 0.2);
        }

        .sos-need-option:has(input[type="checkbox"]:checked)::before {
            background: #dc3545;
            width: 5px;
        }

        .sos-need-option .form-check-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .sos-need-option .form-check-label {
            display: flex;
            align-items: center;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            width: 100%;
            margin: 0;
        }

        .sos-option-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .sos-option-icon i {
            font-size: 1.5rem;
            color: #dc3545;
            transition: all 0.3s ease;
        }

        .sos-need-option:hover .sos-option-icon {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: scale(1.1);
        }

        .sos-need-option:hover .sos-option-icon i {
            color: #dc3545;
        }

        .sos-need-option:has(input[type="checkbox"]:checked) .sos-option-icon {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .sos-need-option:has(input[type="checkbox"]:checked) .sos-option-icon i {
            color: #dc3545;
        }

        .sos-option-content {
            flex: 1;
        }

        .sos-option-title {
            font-size: 1rem;
            font-weight: 700;
            color: #2D3748;
            margin-bottom: 0.25rem;
            letter-spacing: 0.3px;
        }

        .sos-option-description {
            font-size: 0.875rem;
            color: #718096;
            font-weight: 500;
        }

        .sos-need-option:has(input[type="checkbox"]:checked) .sos-option-title {
            color: #dc3545;
        }

        .sos-other-input-container {
            margin-top: 1rem;
            animation: sosSlideDown 0.3s ease-out;
        }

        @@keyframes sosSlideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sos-other-input-container input {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.875rem 1.25rem;
            transition: all 0.3s ease;
        }

        .sos-other-input-container input:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.1);
            outline: none;
        }

        /* Error state styling */
        .sos-need-option.error-state {
            border-color: #dc3545 !important;
            background: #fff5f5 !important;
            animation: sosShake 0.5s ease;
        }

        @@keyframes sosShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Responsive design */
        @@media (max-width: 576px) {
            .sos-need-option .form-check-label {
                padding: 1rem;
            }

            .sos-option-icon {
                width: 40px;
                height: 40px;
                margin-right: 0.75rem;
            }

            .sos-option-icon i {
                font-size: 1.25rem;
            }

            .sos-option-title {
                font-size: 0.95rem;
            }

            .sos-option-description {
                font-size: 0.8rem;
            }
        }

        .sos-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            box-shadow: 0 4px 14px rgba(220, 53, 69, 0.5) !important;
            animation: pulse-red 2s infinite;
        }

        .sos-btn:hover {
            box-shadow: 0 8px 24px rgba(220, 53, 69, 0.7) !important;
            animation: none;
        }

        @@keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 4px 14px rgba(220, 53, 69, 0.5);
            }
            50% {
                box-shadow: 0 4px 20px rgba(220, 53, 69, 0.8), 0 0 0 4px rgba(220, 53, 69, 0.2);
            }
        }

        /* Help is on the Way Modal Styles */
        #helpOnTheWayModal .modal-dialog {
            max-height: 95vh;
            margin: 0.5rem auto;
            display: flex;
            align-items: center;
        }

        .help-on-the-way-modal-content {
            border: 3px solid #10b981;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.5);
            animation: helpModalEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            max-height: calc(95vh - 1rem);
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        @@keyframes helpModalEntrance {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .help-on-the-way-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-bottom: none;
            padding: 0.875rem 1.25rem;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .help-on-the-way-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: helpPulse 3s ease-in-out infinite;
        }

        @@keyframes helpPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .help-on-the-way-header .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        .help-on-the-way-header .modal-title i {
            font-size: 1.5rem;
            animation: helpIconFlash 1.5s ease-in-out infinite;
        }

        @@keyframes helpIconFlash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .help-on-the-way-body {
            padding: 1.5rem 1.25rem;
            background: #ffffff;
            text-align: center;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            max-height: calc(95vh - 200px);
        }

        .help-message-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .help-icon-wrapper {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            animation: helpIconBounce 2s ease-in-out infinite;
        }

        @@keyframes helpIconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .help-icon-wrapper i {
            color: white;
            font-size: 3rem;
        }

        .help-title {
            color: #059669;
            font-weight: 700;
            font-size: 1.75rem;
            margin: 0;
        }

        .help-message {
            color: #374151;
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 0;
            max-width: 500px;
        }

        .help-info-box {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }

        .help-info-box i {
            color: #059669;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .help-info-box span {
            color: #065f46;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .help-on-the-way-footer {
            border-top: 3px solid #d1fae5;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            display: flex;
            justify-content: center;
        }

        .help-on-the-way-footer .btn-primary {
            padding: 1rem 3rem;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-on-the-way-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        @@media (max-width: 768px) {
            .help-on-the-way-header {
                padding: 1.5rem;
            }

            .help-on-the-way-header .modal-title {
                font-size: 1.25rem;
            }

            .help-on-the-way-body {
                padding: 2rem 1.5rem;
            }

            .help-icon-wrapper {
                width: 80px;
                height: 80px;
            }

            .help-icon-wrapper i {
                font-size: 2.5rem;
            }

            .help-title {
                font-size: 1.5rem;
            }

            .help-message {
                font-size: 1rem;
            }
        }

        /* Follow-up Reminder Modal Styles */
        .follow-up-modal-content {
            border: 3px solid #f59e0b;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4);
            animation: followUpModalEntrance 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        @@keyframes followUpModalEntrance {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .follow-up-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        .follow-up-header .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
        }

        .follow-up-header .modal-title i {
            font-size: 1.5rem;
            animation: followUpIconPulse 2s ease-in-out infinite;
        }

        @@keyframes followUpIconPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        .follow-up-body {
            padding: 2rem 1.5rem;
            background: #ffffff;
            text-align: center;
        }

        .follow-up-message-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .follow-up-icon-wrapper {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
        }

        .follow-up-icon-wrapper i {
            color: #f59e0b;
            font-size: 3rem;
        }

        .follow-up-title {
            color: #d97706;
            font-weight: 700;
            font-size: 1.75rem;
            margin: 0;
        }

        .follow-up-message {
            color: #374151;
            font-size: 1.1rem;
            line-height: 1.6;
            margin: 0;
            max-width: 500px;
        }

        .follow-up-info-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
        }

        .follow-up-info-box i {
            color: #d97706;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .follow-up-info-box span {
            color: #92400e;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .follow-up-footer {
            border-top: 3px solid #fef3c7;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .follow-up-follow-btn {
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
        }

        .follow-up-follow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
        }

        .follow-up-received-btn {
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
        }

        .follow-up-received-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        @@media (max-width: 768px) {
            .follow-up-footer {
                flex-direction: column;
            }

            .follow-up-follow-btn,
            .follow-up-received-btn {
                width: 100%;
            }
        }
    </style>
}