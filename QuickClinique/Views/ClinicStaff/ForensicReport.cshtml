@model QuickClinique.Models.Student
@{
    ViewData["Title"] = $"Forensic Report - {Model.FirstName} {Model.LastName}";
    Layout = "_Layout";
    var triageRecords = ViewBag.TriageRecords as List<QuickClinique.Models.Precord> ?? new List<QuickClinique.Models.Precord>();
    var stats = ViewBag.Statistics as dynamic;
}

@section Styles {
    <link rel="stylesheet" href="~/css/forensic-report.css" asp-append-version="true" />
}

<div class="forensic-report-container">
    <div class="no-print mb-3">
        <a href="@Url.Action("ForensicReport", "Clinicstaff")" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to Student List
        </a>
    </div>

    <div class="forensic-form-card">
        <div class="form-header">
            <h2><i class="fas fa-file-medical-alt"></i> FORENSIC MEDICAL REPORT</h2>
            <p class="subtitle">University of Cebu Medical-Dental Clinic</p>
            <p class="subtitle-small">Sanciangko St, Cebu City</p>
        </div>

        <form id="forensicReportForm" method="post" action="@Url.Action("GenerateForensicReportPdf", "Clinicstaff")">
            @Html.AntiForgeryToken()
            <input type="hidden" name="studentId" value="@Model.StudentId" />

            <!-- Patient Information Section -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-user"></i> Patient Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patientName">Patient Name <span class="required">*</span></label>
                        <input type="text" id="patientName" name="patientName" class="form-control" 
                               value="@($"{Model.FirstName} {Model.LastName}")" required />
                    </div>
                    <div class="form-group">
                        <label for="idNumber">ID Number</label>
                        <input type="text" id="idNumber" name="idNumber" class="form-control" 
                               value="@Model.Idnumber" readonly />
                    </div>
                    <div class="form-group">
                        <label for="birthdate">Date of Birth</label>
                        <input type="date" id="birthdate" name="birthdate" class="form-control" 
                               value="@(Model.Birthdate?.ToString("yyyy-MM-dd"))" />
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <input type="text" id="gender" name="gender" class="form-control" 
                               value="@Model.Gender" readonly />
                    </div>
                </div>
            </div>

            <!-- Report Details Section -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-clipboard-list"></i> Report Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reportDate">Report Date</label>
                        <input type="datetime-local" id="reportDate" name="reportDate" class="form-control" 
                               value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                    </div>
                    <div class="form-group full-width">
                        <label for="chiefComplaint">Chief Complaint</label>
                        <textarea id="chiefComplaint" name="chiefComplaint" class="form-control" rows="3" 
                                  placeholder="Enter the chief complaint..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="historyOfPresentIllness">History of Present Illness</label>
                        <textarea id="historyOfPresentIllness" name="historyOfPresentIllness" class="form-control" rows="4" 
                                  placeholder="Enter the history of present illness..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="physicalExamination">Physical Examination Findings</label>
                        <textarea id="physicalExamination" name="physicalExamination" class="form-control" rows="4" 
                                  placeholder="Enter physical examination findings..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="diagnosis">Diagnosis</label>
                        <textarea id="diagnosis" name="diagnosis" class="form-control" rows="3" 
                                  placeholder="Enter diagnosis..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="treatmentPlan">Treatment Plan</label>
                        <textarea id="treatmentPlan" name="treatmentPlan" class="form-control" rows="4" 
                                  placeholder="Enter treatment plan..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="recommendations">Recommendations</label>
                        <textarea id="recommendations" name="recommendations" class="form-control" rows="3" 
                                  placeholder="Enter recommendations..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="additionalNotes">Additional Notes</label>
                        <textarea id="additionalNotes" name="additionalNotes" class="form-control" rows="3" 
                                  placeholder="Enter any additional notes..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Statistics Section (Read-only) -->
            @if (stats != null)
            {
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-chart-bar"></i> Patient Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>@stats.TotalVisits</h4>
                            <p>Total Visits</p>
                        </div>
                        <div class="stat-card">
                            <h4>@stats.TotalRecords</h4>
                            <p>Medical Records</p>
                        </div>
                        @if (stats.AveragePulseRate != null)
                        {
                            <div class="stat-card">
                                <h4>@(Convert.ToDouble(stats.AveragePulseRate).ToString("F1"))</h4>
                                <p>Avg Pulse Rate (bpm)</p>
                            </div>
                        }
                        @if (stats.AverageTemperature != null)
                        {
                            <div class="stat-card">
                                <h4>@(Convert.ToDouble(stats.AverageTemperature).ToString("F1"))</h4>
                                <p>Avg Temperature (Â°C)</p>
                            </div>
                        }
                        @if (stats.AverageOxygenSaturation != null)
                        {
                            <div class="stat-card">
                                <h4>@(Convert.ToDouble(stats.AverageOxygenSaturation).ToString("F1"))</h4>
                                <p>Avg O2 Saturation (%)</p>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Triage Records Table (Read-only) -->
            @if (triageRecords.Any())
            {
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-table"></i> Triage Records</h3>
                    <div class="table-responsive">
                        <table class="triage-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Pulse Rate</th>
                                    <th>Blood Pressure</th>
                                    <th>Temperature</th>
                                    <th>O2 Saturation</th>
                                    <th>BMI</th>
                                    <th>Taken By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in triageRecords)
                                {
                                    <tr>
                                        <td>@(record.TriageDateTime?.ToString("MMM dd, yyyy HH:mm") ?? "N/A")</td>
                                        <td>@(record.PulseRate?.ToString() ?? "N/A")</td>
                                        <td>@(record.BloodPressure ?? "N/A")</td>
                                        <td>@(record.Temperature?.ToString("F1") ?? "N/A")</td>
                                        <td>@(record.OxygenSaturation?.ToString() ?? "N/A")</td>
                                        <td>@record.Bmi</td>
                                        <td>@(record.TriageTakenByName ?? "N/A")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <!-- Physician Information Section -->
            <div class="form-section">
                <h3 class="section-title"><i class="fas fa-user-md"></i> Attending Physician</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="physicianHonorific">Honorific</label>
                        <select id="physicianHonorific" name="physicianHonorific" class="form-control">
                            <option value="">Select...</option>
                            <option value="Dr.">Dr.</option>
                            <option value="Ms.">Ms.</option>
                            <option value="Mr.">Mr.</option>
                            <option value="Mrs.">Mrs.</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendingPhysicianName">Physician Name</label>
                        <input type="text" id="attendingPhysicianName" name="attendingPhysicianName" class="form-control" 
                               value="@(ViewBag.CurrentStaffName as string ?? "")"
                               placeholder="Enter physician name..." />
                    </div>
                    <div class="form-group">
                        <label for="physicianLicenseNumber">License Number</label>
                        <input type="text" id="physicianLicenseNumber" name="physicianLicenseNumber" class="form-control" 
                               value="@(ViewBag.CurrentStaffLicenseNumber as string ?? "")"
                               pattern="\d{2}\s\d{6}" 
                               placeholder="22 123456" />
                        <small class="form-text">Format: 2 digits, space, 6 digits</small>
                    </div>
                    <div class="form-group">
                        <label for="signatureDate">Signature Date</label>
                        <input type="datetime-local" id="signatureDate" name="signatureDate" class="form-control" 
                               value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn-generate-pdf">
                    <i class="fas fa-file-pdf"></i> Generate PDF Report
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // License number formatting
        document.getElementById('physicianLicenseNumber')?.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + ' ' + value.substring(2, 8);
            }
            if (value.length > 9) {
                value = value.substring(0, 9);
            }
            this.value = value;
        });

        // Form submission
        document.getElementById('forensicReportForm')?.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            }
        });
    </script>
}
