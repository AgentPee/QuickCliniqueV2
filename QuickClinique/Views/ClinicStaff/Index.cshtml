@model IEnumerable<QuickClinique.Models.Clinicstaff>
@{
    ViewData["Title"] = "Clinic Staff";
}
@section Styles {
    <link rel="stylesheet" href="~/css/StaffIndex.css" />
}

<div class="staff-management">
    <div class="staff-header">
        <h2><i class="fas fa-user-md"></i> Clinic Staff</h2>

 

  
    </div>

    <div class="staff-table-container" style="overflow-x: auto !important; -webkit-overflow-scrolling: touch;">
        <table class="staff-table" style="min-width: 1200px;">
            <thead>
                <tr>
               
                    <th><i class="fas fa-user"></i> Name</th>
                    <th><i class="fas fa-envelope"></i> Email</th>
                    <th><i class="fas fa-phone"></i> Phone Number</th>
                    <th><i class="fas fa-user-tag"></i> User Role</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-cog"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-user"></i> @item.FirstName @item.LastName
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-envelope"></i> @item.Email
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-phone"></i> @item.PhoneNumber
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-user-tag"></i> @item.User?.Role
                            </span>
                        </td>
                        <td>
                            <div class="flex-align-center">
                                @{
                                    var isActive = item.IsActive;
                                    var staffName = $"{item.FirstName} {item.LastName}";
                                    var escapedName = staffName.Replace("'", "\\'").Replace("\"", "\\\"");
                                }
                                @if (isActive)
                                {
                                    <span class="badge badge-success">
                                        <i class="fas fa-check-circle"></i> Active
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-danger">
                                        <i class="fas fa-ban"></i> Inactive
                                    </span>
                                }
                                @if (isActive)
                                {
                                    <button onclick="showToggleModal(@item.ClinicStaffId, '@Html.Raw(escapedName)', true)" class="btn btn-danger btn-sm btn-sm-custom">
                                        <i class="fas fa-ban"></i> Deactivate
                                    </button>
                                }
                                else
                                {
                                    <button onclick="showToggleModal(@item.ClinicStaffId, '@Html.Raw(escapedName)', false)" class="btn btn-success btn-sm btn-sm-custom">
                                        <i class="fas fa-check"></i> Activate
                                    </button>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="showDetailsModal(@item.ClinicStaffId)" class="btn btn-info btn-sm">
                                    <i class="fas fa-eye"></i> DETAILS
                                </button>
                                <button onclick="showEditModal(@item.ClinicStaffId)" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit"></i> EDIT
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-user-md"></i> Staff Details</h2>
            <button class="modal-close" onclick="closeModal('detailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailsModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Staff Information</h2>
            <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
        </div>
        <div class="modal-body" id="editModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Active Modal -->
<div id="toggleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="toggleModalHeader">
            <h2><i class="fas fa-exclamation-triangle"></i> <span id="toggleModalTitle">Confirm Action</span></h2>
            <button class="modal-close" onclick="closeModal('toggleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="toggleMessage" class="toggle-message-text"></p>
            <div class="toggle-modal-buttons">
                <button onclick="closeModal('toggleModal')" class="btn btn-secondary toggle-modal-button">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="confirmToggle()" class="btn btn-primary toggle-modal-button" id="toggleConfirmButton">
                    <i class="fas fa-check"></i> <span id="toggleConfirmText">Confirm</span>
                </button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_EmergencyPolling")

@section Scripts {
    <script>
        let currentToggleId = null;
        let currentToggleIsActive = null;

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Details Modal
        async function showDetailsModal(staffId) {
            openModal('detailsModal');
            const modalBody = document.getElementById('detailsModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>';

            try {
                const response = await fetch(`/Clinicstaff/Details/${staffId}`);
                
                if (!response.ok) throw new Error('Failed to load staff details');
                
                // Check if response is JSON (AJAX request)
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Build HTML from JSON data
                        const staff = result.data;
                        modalBody.innerHTML = buildStaffDetailsHTML(staff);
                    } else {
                        throw new Error(result.error || 'Failed to load staff details');
                    }
                } else {
                    // Regular HTML response
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const content = doc.querySelector('.staff-details-container');
                    
                    if (content) {
                        // Remove back button and action buttons
                        const backBtn = content.querySelector('a[href*="/Clinicstaff"]');
                        if (backBtn && backBtn.textContent.includes('Back')) backBtn.remove();
                        const actionButtons = content.querySelector('.action-buttons');
                        if (actionButtons) actionButtons.remove();
                        
                        // Remove details header since we have it in modal header
                        const detailsHeader = content.querySelector('.details-header');
                        if (detailsHeader) detailsHeader.remove();
                        
                        modalBody.innerHTML = content.innerHTML;
                        
                        // Fix image paths if any
                        fixImagePaths(modalBody);
                    } else {
                        modalBody.innerHTML = '<p class="modal-error-text">Failed to load staff details.</p>';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading staff details. Please try again.</p>';
            }
        }

        function buildStaffDetailsHTML(staff) {
            const statusBadge = staff.isActive 
                ? '<span class="badge badge-success" style="padding: 0.5rem 1rem; border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 0.875rem; font-weight: 600;"><i class="fas fa-check-circle"></i> Active</span>'
                : '<span class="badge badge-danger" style="padding: 0.5rem 1rem; border-radius: 8px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 0.875rem; font-weight: 600;"><i class="fas fa-ban"></i> Inactive</span>';
            
            const firstName = staff.firstName || '';
            const lastName = staff.lastName || '';
            const initials = (firstName.charAt(0) || '') + (lastName.charAt(0) || '');
            
            // Build birthdate HTML if available
            let birthdateHTML = '';
            if (staff.birthdate) {
                try {
                    const birthdate = new Date(staff.birthdate);
                    // Check if date is valid
                    if (!isNaN(birthdate.getTime())) {
                        const today = new Date();
                        let age = today.getFullYear() - birthdate.getFullYear();
                        const monthDiff = today.getMonth() - birthdate.getMonth();
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                            age--;
                        }
                        // Only show age if it's a valid positive number
                        if (age < 0) age = 0;
                        
                        const formattedDate = birthdate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        birthdateHTML = `
                            <div class="detail-item" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1);">
                                <div class="detail-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #718096); font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-birthday-cake"></i> Birthdate
                                </div>
                                <div class="detail-value" style="font-size: 1.125rem; font-weight: 600; color: var(--text-dark, #2D3748);">
                                    ${formattedDate}
                                    ${age >= 0 ? `<span style="color: var(--text-muted, #718096); font-size: 0.875rem; font-weight: 500; margin-left: 0.5rem;">(Age: ${age})</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error('Error parsing birthdate:', e);
                }
            }
            
            // Build gender HTML if available
            const genderHTML = staff.gender ? `
                <div class="detail-item" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1);">
                    <div class="detail-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #718096); font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-venus-mars"></i> Gender
                    </div>
                    <div class="detail-value" style="font-size: 1.125rem; font-weight: 600; color: var(--text-dark, #2D3748);">
                        ${staff.gender}
                    </div>
                </div>
            ` : '';
            
            return `
                <div class="staff-info-card" style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
                    <div class="staff-profile" style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid rgba(78, 205, 196, 0.15);">
                        <div class="profile-avatar" style="font-size: 4.5rem; color: var(--primary-teal, #179C8E); background: linear-gradient(135deg, rgba(78, 205, 196, 0.2) 0%, rgba(68, 160, 141, 0.2) 100%); width: 110px; height: 110px; border-radius: 50%; border: 3px solid rgba(78, 205, 196, 0.4); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(78, 205, 196, 0.2);">
                            ${initials}
                        </div>
                        <div>
                            <h2 class="staff-name" style="font-size: 1.875rem; margin-bottom: 0.5rem; font-weight: 800;">
                                <span class="first-name" style="color: var(--primary-teal, #179C8E);">${firstName}</span>
                                <span class="last-name" style="color: var(--secondary-teal, #0F3D57);">${lastName}</span>
                            </h2>
                            <p style="color: #718096; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                <i class="fas fa-id-card"></i> Staff ID: #${staff.clinicStaffId || ''}
                            </p>
                            ${staff.user ? `<span class="role-badge" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 25px; font-size: 0.8125rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; color: #FFFFFF !important; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2); background: linear-gradient(135deg, var(--primary-teal, #179C8E) 0%, var(--primary-cyan, #4FC4D3) 100%);"><i class="fas fa-user-tag"></i> ${staff.user.role || ''}</span>` : ''}
                        </div>
                    </div>
                    <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div class="detail-item" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1);">
                            <div class="detail-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #718096); font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-envelope"></i> Email Address
                            </div>
                            <div class="detail-value" style="font-size: 1.125rem; font-weight: 600; color: var(--text-dark, #2D3748);">
                                ${staff.email || 'N/A'}
                            </div>
                        </div>
                        <div class="detail-item" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1);">
                            <div class="detail-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #718096); font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-phone"></i> Phone Number
                            </div>
                            <div class="detail-value" style="font-size: 1.125rem; font-weight: 600; color: var(--text-dark, #2D3748);">
                                ${staff.phoneNumber || 'N/A'}
                            </div>
                        </div>
                        ${birthdateHTML}
                        ${genderHTML}
                        <div class="detail-item" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1);">
                            <div class="detail-label" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted, #718096); font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-toggle-on"></i> Account Status
                            </div>
                            <div class="detail-value" style="font-size: 1.125rem; font-weight: 600; color: var(--text-dark, #2D3748); display: flex; align-items: center; gap: 0.75rem;">
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                </div>
                ${buildIdImagesSection(staff)}
            `;
        }

        function buildIdImagesSection(staff) {
            // Parse image paths (comma-separated: front, back)
            let idFrontImage = null;
            let idBackImage = null;
            
            if (staff.image) {
                const imagePaths = staff.image.split(',').map(path => path.trim()).filter(path => path);
                if (imagePaths.length > 0) {
                    idFrontImage = imagePaths[0];
                }
                if (imagePaths.length > 1) {
                    idBackImage = imagePaths[1];
                }
            }
            
            // Build front image HTML
            const frontImageHTML = idFrontImage ? `
                <div class="insurance-receipt-container" style="text-align: center;">
                    <div class="current-file">
                        <p style="font-weight: 600; color: var(--text-dark, #2D3748); margin-bottom: 1rem; font-size: 0.875rem;">Current ID Front:</p>
                        <img src="${idFrontImage}" alt="ID Front" class="preview-image" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 1rem; cursor: pointer;" onclick="openImageModal('${idFrontImage}', 'Staff ID Front')" />
                        <a href="${idFrontImage}" target="_blank" class="btn btn-sm btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--primary-teal, #179C8E) 0%, var(--primary-cyan, #4FC4D3) 100%); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-external-link-alt"></i> View Full Size
                        </a>
                    </div>
                </div>
            ` : `
                <div class="document-placeholder" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted, #718096);">
                    <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p style="margin: 0; font-weight: 500;">No ID Front image available</p>
                </div>
            `;
            
            // Build back image HTML
            const backImageHTML = idBackImage ? `
                <div class="insurance-receipt-container" style="text-align: center;">
                    <div class="current-file">
                        <p style="font-weight: 600; color: var(--text-dark, #2D3748); margin-bottom: 1rem; font-size: 0.875rem;">Current ID Back:</p>
                        <img src="${idBackImage}" alt="ID Back" class="preview-image" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 1rem; cursor: pointer;" onclick="openImageModal('${idBackImage}', 'Staff ID Back')" />
                        <a href="${idBackImage}" target="_blank" class="btn btn-sm btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--primary-teal, #179C8E) 0%, var(--primary-cyan, #4FC4D3) 100%); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-external-link-alt"></i> View Full Size
                        </a>
                    </div>
                </div>
            ` : `
                <div class="document-placeholder" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted, #718096);">
                    <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p style="margin: 0; font-weight: 500;">No ID Back image available</p>
                </div>
            `;
            
            return `
                <div class="documents-section" style="background: white; border-radius: 12px; padding: 2rem; margin-top: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
                    <div class="section-header" style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(78, 205, 196, 0.15);">
                        <h3 class="section-title" style="font-size: 1.5rem; font-weight: 700; color: var(--text-dark, #2D3748); display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-id-card" style="color: var(--primary-teal, #179C8E);"></i>
                            Staff ID Documents
                        </h3>
                    </div>
                    <div class="documents-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div class="document-card" style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1); overflow: hidden;">
                            <div class="document-header" style="background: linear-gradient(135deg, var(--primary-teal, #179C8E) 0%, var(--primary-cyan, #4FC4D3) 100%); padding: 1.25rem; color: white;">
                                <h4 class="document-title" style="font-size: 1.125rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-id-card"></i> ID Front
                                </h4>
                            </div>
                            <div class="document-content" style="padding: 1.5rem;">
                                ${frontImageHTML}
                            </div>
                        </div>
                        <div class="document-card" style="background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 12px; border: 2px solid rgba(78, 205, 196, 0.1); overflow: hidden;">
                            <div class="document-header" style="background: linear-gradient(135deg, var(--primary-teal, #179C8E) 0%, var(--primary-cyan, #4FC4D3) 100%); padding: 1.25rem; color: white;">
                                <h4 class="document-title" style="font-size: 1.125rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-id-card"></i> ID Back
                                </h4>
                            </div>
                            <div class="document-content" style="padding: 1.5rem;">
                                ${backImageHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Image Modal Functions
        function openImageModal(imageSrc, title) {
            // Check if modal exists, if not create it
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'modal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); justify-content: center; align-items: center;';
                modal.innerHTML = `
                    <div class="modal-content modal-large" style="background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh; position: relative; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
                        <div class="modal-header" style="padding: 1.5rem; border-bottom: 2px solid rgba(78, 205, 196, 0.15); display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-dark, #2D3748); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-image" style="color: var(--primary-teal, #179C8E);"></i> 
                                <span id="imageModalTitle">Image</span>
                            </h2>
                            <button class="modal-close" onclick="closeImageModal()" style="background: none; border: none; font-size: 2rem; color: var(--text-muted, #718096); cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 2rem; max-height: calc(90vh - 100px); overflow: auto;">
                            <img id="modalImage" src="" alt="Document Image" style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);" />
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeImageModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && modal.style.display === 'flex') {
                        closeImageModal();
                    }
                });
            }
            
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('imageModalTitle');
            
            modalImage.src = imageSrc;
            modalTitle.textContent = title;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function fixImagePaths(container) {
            // Fix image paths - convert relative paths to absolute URLs
            const images = container.querySelectorAll('img[src]');
            images.forEach(img => {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('http') && !src.startsWith('//') && !src.startsWith('data:')) {
                    if (src.startsWith('/')) {
                        img.src = src;
                    } else if (src.startsWith('~/')) {
                        img.src = src.replace('~/', '/');
                    } else {
                        img.src = '/' + src;
                    }
                }
            });
            
            // Fix anchor hrefs for image links
            const imageLinks = container.querySelectorAll('a[href]');
            imageLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#')) {
                    if (href.startsWith('/')) {
                        link.href = href;
                    } else if (href.startsWith('~/')) {
                        link.href = href.replace('~/', '/');
                    } else {
                        link.href = '/' + href;
                    }
                }
            });
        }

        // Edit Modal
        async function showEditModal(staffId) {
            openModal('editModal');
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>';

            try {
                const response = await fetch(`/Clinicstaff/Edit/${staffId}`);
                if (!response.ok) throw new Error('Failed to load staff data');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.staff-edit-container');
                
                if (content) {
                    // Replace cancel button that links to Index
                    const cancelBtn = content.querySelector('a[href*="/Clinicstaff"]');
                    if (cancelBtn && (cancelBtn.textContent.includes('Cancel') || cancelBtn.textContent.includes('Back'))) {
                        const newCancelBtn = document.createElement('button');
                        newCancelBtn.type = 'button';
                        newCancelBtn.className = 'btn btn-secondary';
                        newCancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                        newCancelBtn.onclick = () => closeModal('editModal');
                        cancelBtn.replaceWith(newCancelBtn);
                    }
                    
                    // Remove the edit header since we have it in the modal header
                    const editHeader = content.querySelector('.edit-header');
                    if (editHeader) {
                        editHeader.remove();
                    }
                    
                    modalBody.innerHTML = content.innerHTML;
                    
                    // Setup form submission after content is loaded
                    const loadedForm = modalBody.querySelector('form');
                    if (loadedForm) {
                        loadedForm.addEventListener('submit', (e) => submitEditForm(e, staffId));
                        
                        // Initialize password validation
                        initializePasswordValidation();
                        
                        // Initialize phone number validation
                        initializePhoneValidation();
                        
                        // Initialize input touched state
                        initializeInputTouched();
                    } else {
                        modalBody.innerHTML = '<p class="modal-error-text">Failed to load edit form.</p>';
                    }
                } else {
                    modalBody.innerHTML = '<p class="modal-error-text">Failed to load edit form.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading edit form. Please try again.</p>';
            }
        }

        async function submitEditForm(event, staffId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Get anti-forgery token from the form itself or the main page
            let token = form.querySelector('input[name="__RequestVerificationToken"]');
            if (!token) {
                token = document.querySelector('input[name="__RequestVerificationToken"]');
            }
            if (token) {
                formData.append('__RequestVerificationToken', token.value);
            }
            
            // Ensure all form fields are included in FormData
            // Get Birthdate value explicitly (since it uses name="Birthdate" instead of asp-for)
            const birthdateInput = form.querySelector('input[name="Birthdate"]');
            if (birthdateInput) {
                // The controller expects 'birthdate' parameter (lowercase)
                formData.set('birthdate', birthdateInput.value || '');
            }
            
            // Debug: Log form data
            console.log('Form Data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(key + ':', value);
            }
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalHtml = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`/Clinicstaff/Edit/${staffId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const result = await response.json();

                    if (result.success) {
                        showNotification(result.message || 'Staff information updated successfully!', 'success');
                        closeModal('editModal');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        // Display validation errors
                        let errorMessage = result.error || result.message || 'Failed to update staff information.';
                        
                        if (result.errors) {
                            const errorList = Object.entries(result.errors)
                                .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                                .join('<br>');
                            errorMessage += '<br><small>' + errorList + '</small>';
                        }
                        
                        showNotification(errorMessage, 'error');
                        submitBtn.innerHTML = originalHtml;
                        submitBtn.disabled = false;
                    }
                } else {
                    // If not JSON, might be HTML (validation errors)
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const validationSummary = doc.querySelector('.validation-summary');
                    
                    if (validationSummary) {
                        showNotification('Validation errors occurred. Please check the form.', 'error');
                    } else {
                        showNotification('Staff information updated successfully!', 'success');
                        closeModal('editModal');
                        setTimeout(() => location.reload(), 1000);
                    }
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating staff information. Please try again.', 'error');
                submitBtn.innerHTML = originalHtml;
                submitBtn.disabled = false;
            }
        }

        function showToggleModal(staffId, staffName, isCurrentlyActive) {
            currentToggleId = staffId;
            currentToggleIsActive = isCurrentlyActive;
            
            const toggleModal = document.getElementById('toggleModal');
            const toggleMessage = document.getElementById('toggleMessage');
            const toggleTitle = document.getElementById('toggleModalTitle');
            const toggleHeader = document.getElementById('toggleModalHeader');
            const toggleConfirmButton = document.getElementById('toggleConfirmButton');
            const toggleConfirmText = document.getElementById('toggleConfirmText');
            
            if (isCurrentlyActive) {
                // Deactivating
                toggleTitle.textContent = 'Confirm Deactivate';
                toggleMessage.textContent = `Are you sure you want to deactivate staff member "${staffName}"? They will no longer be able to login to the system.`;
                toggleHeader.className = 'modal-header modal-header-danger';
                toggleConfirmButton.className = 'btn';
                toggleConfirmButton.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                toggleConfirmButton.style.color = 'white';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmButton.style.minWidth = '120px';
                toggleConfirmText.innerHTML = '<i class="fas fa-ban"></i> Deactivate';
            } else {
                // Activating
                toggleTitle.textContent = 'Confirm Activate';
                toggleMessage.textContent = `Are you sure you want to activate staff member "${staffName}"? They will be able to login to the system again.`;
                toggleHeader.className = 'modal-header';
                toggleHeader.style.background = 'linear-gradient(135deg, rgba(78, 205, 196, 0.95) 0%, rgba(68, 160, 141, 0.95) 100%)';
                toggleConfirmButton.className = 'btn btn-primary';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmButton.style.minWidth = '120px';
                toggleConfirmText.innerHTML = '<i class="fas fa-check"></i> Activate';
            }
            
            openModal('toggleModal');
        }

        async function confirmToggle() {
            if (!currentToggleId) return;

            const toggleModal = document.getElementById('toggleModal');
            const modalBody = toggleModal.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Updating...</div>';

            try {
                const formData = new FormData();
                
                let token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }

                const response = await fetch(`/Clinicstaff/ToggleActiveStaff/${currentToggleId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message || 'Staff status updated successfully!', 'success');
                    closeModal('toggleModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error(result.message || 'Failed to update staff status');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating staff status. Please try again.', 'error');
                closeModal('toggleModal');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Initialize password validation for dynamically loaded forms
        function initializePasswordValidation() {
            const newPasswordInput = document.querySelector('#newPassword');
            const confirmPasswordInput = document.querySelector('#confirmPassword');
            const confirmPasswordError = document.querySelector('#confirmPasswordError');

            if (!newPasswordInput || !confirmPasswordInput) return;

            function validatePasswordMatch() {
                const password = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // If new password is entered, confirm password is required and must match
                if (password && confirmPassword) {
                    if (password !== confirmPassword) {
                        if (confirmPasswordError) {
                            confirmPasswordError.textContent = 'Passwords do not match. Please ensure both passwords are identical.';
                            confirmPasswordError.style.display = 'block';
                        }
                        confirmPasswordInput.classList.add('is-invalid');
                        confirmPasswordInput.classList.remove('is-valid');
                        newPasswordInput.classList.add('is-invalid');
                        return false;
                    } else {
                        if (confirmPasswordError) {
                            confirmPasswordError.style.display = 'none';
                        }
                        confirmPasswordInput.classList.remove('is-invalid');
                        confirmPasswordInput.classList.add('is-valid');
                        newPasswordInput.classList.remove('is-invalid');
                        newPasswordInput.classList.add('is-valid');
                        return true;
                    }
                } else if (password && !confirmPassword) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Please confirm your password. Both fields must match.';
                        confirmPasswordError.style.display = 'block';
                    }
                    confirmPasswordInput.classList.add('is-invalid');
                    confirmPasswordInput.classList.remove('is-valid');
                    return false;
                } else if (!password && confirmPassword) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Please enter a new password first before confirming.';
                        confirmPasswordError.style.display = 'block';
                    }
                    confirmPasswordInput.classList.add('is-invalid');
                    confirmPasswordInput.classList.remove('is-valid');
                    return false;
                } else {
                    // Both fields are empty - this is allowed (password change is optional)
                    if (confirmPasswordError) {
                        confirmPasswordError.style.display = 'none';
                    }
                    confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
                    newPasswordInput.classList.remove('is-invalid', 'is-valid');
                    return true;
                }
            }

            newPasswordInput.addEventListener('input', validatePasswordMatch);
            confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            confirmPasswordInput.addEventListener('blur', validatePasswordMatch);

            // Form submission validation
            const form = document.querySelector('.staff-edit-form');
            if (form) {
                const originalSubmit = form.onsubmit;
                form.addEventListener('submit', function(e) {
                    if (!validatePasswordMatch()) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        }

        // Initialize phone number validation
        function initializePhoneValidation() {
            const phoneInput = document.querySelector('#PhoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    const value = this.value;
                    // Remove any non-digit characters
                    this.value = value.replace(/\D/g, '');

                    // Limit to 11 digits
                    if (this.value.length > 11) {
                        this.value = this.value.slice(0, 11);
                    }
                });
            }
        }

        // Initialize input touched state
        function initializeInputTouched() {
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('touched');
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('touched');
                    }
                });
            });
        }

    </script>
}