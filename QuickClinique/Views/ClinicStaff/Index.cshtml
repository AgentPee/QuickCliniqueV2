@model IEnumerable<QuickClinique.Models.Clinicstaff>
@{
    ViewData["Title"] = "Clinic Staff";
}
@section Styles {
    <link rel="stylesheet" href="~/css/StaffIndex.css" />
}

<div class="staff-management">
    <div class="staff-header">
        <h2><i class="fas fa-user-md"></i> Clinic Staff</h2>

 

  
    </div>

    <div class="staff-table-container" style="overflow-x: auto !important; -webkit-overflow-scrolling: touch;">
        <table class="staff-table" style="min-width: 1200px;">
            <thead>
                <tr>
               
                    <th><i class="fas fa-user"></i> Name</th>
                    <th><i class="fas fa-envelope"></i> Email</th>
                    <th><i class="fas fa-phone"></i> Phone Number</th>
                    <th><i class="fas fa-user-tag"></i> User Role</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                    <th><i class="fas fa-cog"></i> Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-staff-id="@item.ClinicStaffId">
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-user"></i> @item.FirstName @item.LastName
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-envelope"></i> @item.Email
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-phone"></i> @item.PhoneNumber
                            </span>
                        </td>
                        <td>
                            <span class="staff-field">
                                <i class="fas fa-user-tag"></i> @item.User?.Role
                            </span>
                        </td>
                        <td>
                            <div class="flex-align-center">
                                @{
                                    var isActive = item.IsActive;
                                    var staffName = $"{item.FirstName} {item.LastName}";
                                    var escapedName = staffName.Replace("'", "\\'").Replace("\"", "\\\"");
                                }
                                @if (isActive)
                                {
                                    <span class="badge badge-success">
                                        <i class="fas fa-check-circle"></i> Active
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-danger">
                                        <i class="fas fa-ban"></i> Inactive
                                    </span>
                                }
                                @if (isActive)
                                {
                                    <button onclick="showToggleModal(@item.ClinicStaffId, '@Html.Raw(escapedName)', true)" class="btn btn-danger btn-sm btn-sm-custom">
                                        <i class="fas fa-ban"></i> Deactivate
                                    </button>
                                }
                                else
                                {
                                    <button onclick="showToggleModal(@item.ClinicStaffId, '@Html.Raw(escapedName)', false)" class="btn btn-success btn-sm btn-sm-custom">
                                        <i class="fas fa-check"></i> Activate
                                    </button>
                                }
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="showDetailsModal(@item.ClinicStaffId)" class="btn btn-info btn-sm">
                                    <i class="fas fa-eye"></i> DETAILS
                                </button>
                                <button onclick="showEditModal(@item.ClinicStaffId)" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit"></i> EDIT
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-user-md"></i> Staff Details</h2>
            <button class="modal-close" onclick="closeModal('detailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailsModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Staff Information</h2>
            <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
        </div>
        <div class="modal-body" id="editModalBody">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Active Modal -->
<div id="toggleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="toggleModalHeader">
            <h2><i class="fas fa-exclamation-triangle"></i> <span id="toggleModalTitle">Confirm Action</span></h2>
            <button class="modal-close" onclick="closeModal('toggleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="toggleMessage" class="toggle-message-text"></p>
            <div class="toggle-modal-buttons">
                <button onclick="closeModal('toggleModal')" class="btn btn-secondary toggle-modal-button">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="confirmToggle()" class="btn btn-primary toggle-modal-button" id="toggleConfirmButton">
                    <span id="toggleConfirmText">Confirm</span>
                </button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_EmergencyPolling")


@section Scripts {
    <script>
        let currentToggleId = null;
        let currentToggleIsActive = null;

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Details Modal
        async function showDetailsModal(staffId) {
            openModal('detailsModal');
            const modalBody = document.getElementById('detailsModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>';

            try {
                const response = await fetch(`/Clinicstaff/Details/${staffId}`);
                if (!response.ok) throw new Error('Failed to load staff details');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.staff-details-container');
                
                if (content) {
                    // Remove back button and action buttons
                    const backBtn = content.querySelector('a[href*="/Clinicstaff"]');
                    if (backBtn && backBtn.textContent.includes('Back')) backBtn.remove();
                    const actionButtons = content.querySelector('.action-buttons');
                    if (actionButtons) actionButtons.remove();
                    
                    // Remove details header since we have it in modal header
                    const detailsHeader = content.querySelector('.details-header');
                    if (detailsHeader) detailsHeader.remove();
                    
                    modalBody.innerHTML = content.innerHTML;
                } else {
                    modalBody.innerHTML = '<p class="modal-error-text">Failed to load staff details.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading staff details. Please try again.</p>';
            }
        }

        // Edit Modal
        async function showEditModal(staffId) {
            openModal('editModal');
            const modalBody = document.getElementById('editModalBody');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><span>Loading...</span></div>';

            try {
                const response = await fetch(`/Clinicstaff/Edit/${staffId}`);
                if (!response.ok) throw new Error('Failed to load staff data');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('.staff-edit-container');
                
                if (content) {
                    // Replace cancel button that links to Index
                    const cancelBtn = content.querySelector('a[href*="/Clinicstaff"]');
                    if (cancelBtn && (cancelBtn.textContent.includes('Cancel') || cancelBtn.textContent.includes('Back'))) {
                        const newCancelBtn = document.createElement('button');
                        newCancelBtn.type = 'button';
                        newCancelBtn.className = 'btn btn-secondary';
                        newCancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                        newCancelBtn.onclick = () => closeModal('editModal');
                        cancelBtn.replaceWith(newCancelBtn);
                    }
                    
                    // Remove the edit header since we have it in the modal header
                    const editHeader = content.querySelector('.edit-header');
                    if (editHeader) {
                        editHeader.remove();
                    }
                    
                    modalBody.innerHTML = content.innerHTML;
                    
                    // Setup form submission after content is loaded
                    const loadedForm = modalBody.querySelector('form');
                    if (loadedForm) {
                        // Remove any existing submit handlers to avoid duplicates
                        const newForm = loadedForm.cloneNode(true);
                        loadedForm.parentNode.replaceChild(newForm, loadedForm);
                        
                        // Add submit event listener with proper prevention
                        newForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            submitEditForm(e, staffId);
                            return false;
                        }, true); // Use capture phase to catch early
                        
                        // Also prevent default on form element itself
                        newForm.onsubmit = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        };
                        
                        // Initialize password validation
                        initializePasswordValidation();
                        
                        // Initialize phone number validation
                        initializePhoneValidation();
                        
                        // Initialize input touched state
                        initializeInputTouched();
                    } else {
                        modalBody.innerHTML = '<p class="modal-error-text">Failed to load edit form.</p>';
                    }
                } else {
                    modalBody.innerHTML = '<p class="modal-error-text">Failed to load edit form.</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                modalBody.innerHTML = '<p class="modal-error-text">Error loading edit form. Please try again.</p>';
            }
        }

        async function submitEditForm(event, staffId) {
            event.preventDefault();
            event.stopPropagation();
            
            const form = event.target;
            
            // Get submit button before creating FormData
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalHtml = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;
            }
            
            // Verify anti-forgery token exists in form BEFORE creating FormData
            let token = form.querySelector('input[name="__RequestVerificationToken"]');
            if (!token) {
                // Try to get from page as fallback
                token = document.querySelector('input[name="__RequestVerificationToken"]');
            }
            
            if (!token) {
                console.error('Anti-forgery token not found in form or page!');
                showNotification('Security token not found. Please refresh the page and try again.', 'error');
                if (submitBtn) {
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                }
                return;
            }
            
            // Create FormData from form - this will automatically include all form fields including the token
            const formData = new FormData(form);
            
            // Ensure token is in FormData (it should be from the form, but double-check)
            if (!formData.has('__RequestVerificationToken')) {
                console.warn('Token not in FormData, adding it manually');
                formData.append('__RequestVerificationToken', token.value);
            }
            
            // Log form data for debugging (without sensitive data)
            const formFields = Array.from(formData.keys()).filter(k => k !== '__RequestVerificationToken' && !k.includes('Password'));
            console.log('Submitting form with fields:', formFields);
            console.log('Form has token:', !!form.querySelector('input[name="__RequestVerificationToken"]'));
            console.log('Staff ID being submitted:', staffId);
            
            // Verify required fields are present
            const requiredFields = ['ClinicStaffId', 'UserId', 'FirstName', 'LastName', 'Email', 'PhoneNumber'];
            const missingFields = requiredFields.filter(field => !formData.has(field));
            if (missingFields.length > 0) {
                console.error('Missing required fields:', missingFields);
                showNotification(`Missing required fields: ${missingFields.join(', ')}. Please refresh and try again.`, 'error');
                if (submitBtn) {
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                }
                return;
            }
            
            try {
                const response = await fetch(`/Clinicstaff/Edit/${staffId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                // Check response status first
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Server error (${response.status}):`, errorText);
                    console.error('Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    // For 400 errors, try to extract more details
                    if (response.status === 400) {
                        // Try to parse as JSON first
                        let errorMessage = `Bad Request (400). `;
                        try {
                            const errorJson = JSON.parse(errorText);
                            if (errorJson.error) {
                                errorMessage += errorJson.error;
                            } else if (errorJson.message) {
                                errorMessage += errorJson.message;
                            } else if (errorJson.errors) {
                                const errorList = Object.entries(errorJson.errors)
                                    .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                                    .join('; ');
                                errorMessage += errorList;
                            } else {
                                errorMessage += 'Please check the console for details.';
                            }
                        } catch {
                            // If not JSON, check if it's HTML with validation errors
                            if (errorText.includes('validation') || errorText.includes('error') || errorText.includes('required')) {
                                errorMessage += 'Validation error occurred. Please check all required fields are filled correctly.';
                            } else {
                                errorMessage += 'Please check the console for details.';
                            }
                        }
                        showNotification(errorMessage, 'error');
                    } else {
                        // For other errors, try to parse as JSON
                        try {
                            const errorJson = JSON.parse(errorText);
                            showNotification(errorJson.error || errorJson.message || `Server error: ${response.status}`, 'error');
                        } catch {
                            showNotification(`Server error (${response.status}): ${response.statusText}. Please check the console for details.`, 'error');
                        }
                    }
                    
                    if (submitBtn) {
                        submitBtn.innerHTML = originalHtml;
                        submitBtn.disabled = false;
                    }
                    return;
                }

                // Check if response is JSON
                const contentType = response.headers.get("content-type") || '';
                if (contentType.includes("application/json")) {
                    const result = await response.json();

                    if (result.success) {
                        showNotification(result.message || 'Staff information updated successfully!', 'success');
                        closeModal('editModal');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        // Display validation errors
                        let errorMessage = result.error || result.message || 'Failed to update staff information.';
                        
                        if (result.errors) {
                            const errorList = Object.entries(result.errors)
                                .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                                .join('<br>');
                            errorMessage += '<br><small>' + errorList + '</small>';
                        }
                        
                        showNotification(errorMessage, 'error');
                        if (submitBtn) {
                            submitBtn.innerHTML = originalHtml;
                            submitBtn.disabled = false;
                        }
                    }
                } else {
                    // If not JSON, might be HTML (validation errors or success page)
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const validationSummary = doc.querySelector('.validation-summary');
                    const editContainer = doc.querySelector('.staff-edit-container');
                    
                    if (validationSummary || editContainer) {
                        // Validation errors - update modal content with the form that has errors
                        const modalBody = document.getElementById('editModalBody');
                        if (editContainer) {
                            // Process the HTML similar to how we load it initially
                            const content = editContainer.cloneNode(true);
                            
                            // Replace cancel button
                            const cancelBtn = content.querySelector('a[href*="/Clinicstaff"]');
                            if (cancelBtn && (cancelBtn.textContent.includes('Cancel') || cancelBtn.textContent.includes('Back'))) {
                                const newCancelBtn = document.createElement('button');
                                newCancelBtn.type = 'button';
                                newCancelBtn.className = 'btn btn-secondary';
                                newCancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                                newCancelBtn.onclick = () => closeModal('editModal');
                                cancelBtn.replaceWith(newCancelBtn);
                            }
                            
                            // Remove the edit header
                            const editHeader = content.querySelector('.edit-header');
                            if (editHeader) {
                                editHeader.remove();
                            }
                            
                            modalBody.innerHTML = content.innerHTML;
                            
                            // Re-setup form submission
                            const loadedForm = modalBody.querySelector('form');
                            if (loadedForm) {
                                // Remove any existing submit handlers to avoid duplicates
                                const newForm = loadedForm.cloneNode(true);
                                loadedForm.parentNode.replaceChild(newForm, loadedForm);
                                
                                // Add submit event listener with proper prevention
                                newForm.addEventListener('submit', function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    submitEditForm(e, staffId);
                                    return false;
                                }, true); // Use capture phase to catch early
                                
                                // Also prevent default on form element itself
                                newForm.onsubmit = function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    return false;
                                };
                                
                                // Re-initialize validations
                                initializePasswordValidation();
                                initializePhoneValidation();
                                initializeInputTouched();
                            }
                            
                            // Scroll to top of modal to show errors
                            modalBody.scrollTop = 0;
                            
                            // Show notification about validation errors
                            const errorText = validationSummary ? validationSummary.textContent.trim() : 'Please correct the errors and try again.';
                            showNotification(errorText || 'Validation errors occurred. Please check the form.', 'error');
                        } else {
                            showNotification('Validation errors occurred. Please check the form.', 'error');
                        }
                    } else {
                        // Might be a redirect or success page - check response status
                        if (response.ok) {
                            showNotification('Staff information updated successfully!', 'success');
                            closeModal('editModal');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showNotification('An error occurred while saving. Please try again.', 'error');
                        }
                    }
                    
                    if (submitBtn) {
                        submitBtn.innerHTML = originalHtml;
                        submitBtn.disabled = false;
                    }
                }
            } catch (error) {
                // Log error to console with timestamp so it persists
                const errorMsg = `[${new Date().toISOString()}] Error updating staff: ${error.message}`;
                console.error(errorMsg, error);
                
                // Also log to a persistent storage if available
                if (typeof sessionStorage !== 'undefined') {
                    try {
                        const errorLog = JSON.parse(sessionStorage.getItem('errorLog') || '[]');
                        errorLog.push({ timestamp: new Date().toISOString(), error: error.message, stack: error.stack });
                        sessionStorage.setItem('errorLog', JSON.stringify(errorLog.slice(-10))); // Keep last 10 errors
                    } catch (e) {
                        // Ignore storage errors
                    }
                }
                
                showNotification('Error updating staff information: ' + error.message + '. Please check the console for details.', 'error');
                if (submitBtn) {
                    submitBtn.innerHTML = originalHtml;
                    submitBtn.disabled = false;
                }
            }
        }

        function showToggleModal(staffId, staffName, isCurrentlyActive) {
            currentToggleId = staffId;
            currentToggleIsActive = isCurrentlyActive;
            
            const toggleModal = document.getElementById('toggleModal');
            const toggleMessage = document.getElementById('toggleMessage');
            const toggleTitle = document.getElementById('toggleModalTitle');
            const toggleHeader = document.getElementById('toggleModalHeader');
            const toggleConfirmButton = document.getElementById('toggleConfirmButton');
            const toggleConfirmText = document.getElementById('toggleConfirmText');
            
            if (isCurrentlyActive) {
                // Deactivating
                toggleTitle.textContent = 'Confirm Deactivate';
                toggleMessage.textContent = `Are you sure you want to deactivate staff member "${staffName}"? They will no longer be able to login to the system.`;
                toggleHeader.className = 'modal-header modal-header-danger';
                toggleConfirmButton.className = 'btn';
                toggleConfirmButton.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                toggleConfirmButton.style.color = 'white';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmButton.style.minWidth = '120px';
                toggleConfirmText.innerHTML = '<i class="fas fa-ban"></i> Deactivate';
            } else {
                // Activating
                toggleTitle.textContent = 'Confirm Activate';
                toggleMessage.textContent = `Are you sure you want to activate staff member "${staffName}"? They will be able to login to the system again.`;
                toggleHeader.className = 'modal-header';
                toggleHeader.style.background = 'linear-gradient(135deg, rgba(78, 205, 196, 0.95) 0%, rgba(68, 160, 141, 0.95) 100%)';
                toggleConfirmButton.className = 'btn btn-primary';
                toggleConfirmButton.style.padding = '0.75rem 2rem';
                toggleConfirmButton.style.minWidth = '120px';
                toggleConfirmText.innerHTML = '<i class="fas fa-check"></i> Activate';
            }
            
            openModal('toggleModal');
        }

        async function confirmToggle() {
            if (!currentToggleId) return;

            const toggleModal = document.getElementById('toggleModal');
            const modalBody = toggleModal.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Updating...</div>';

            try {
                const formData = new FormData();
                
                let token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    formData.append('__RequestVerificationToken', token.value);
                }

                const response = await fetch(`/Clinicstaff/ToggleActiveStaff/${currentToggleId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message || 'Staff status updated successfully!', 'success');
                    closeModal('toggleModal');
                    
                    // Update UI dynamically without reloading
                    updateStaffStatusUI(currentToggleId, result.isActive);
                } else {
                    throw new Error(result.message || 'Failed to update staff status');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating staff status. Please try again.', 'error');
                closeModal('toggleModal');
            }
        }

        // Update staff status UI dynamically
        function updateStaffStatusUI(staffId, isActive) {
            const row = document.querySelector(`tr[data-staff-id="${staffId}"]`);
            if (!row) return;
            
            const statusCell = row.querySelector('td:nth-child(5)'); // Status column
            if (!statusCell) return;
            
            const statusDiv = statusCell.querySelector('.flex-align-center');
            if (!statusDiv) return;
            
            // Get staff name from the row for the button
            const nameCell = row.querySelector('td:nth-child(1)');
            const staffName = nameCell ? nameCell.textContent.trim() : 'Staff';
            
            // Clear existing content
            statusDiv.innerHTML = '';
            
            // Create badge
            const badge = document.createElement('span');
            badge.className = isActive ? 'badge badge-success' : 'badge badge-danger';
            badge.innerHTML = `<i class="fas fa-${isActive ? 'check-circle' : 'ban'}"></i> ${isActive ? 'Active' : 'Inactive'}`;
            statusDiv.appendChild(badge);
            
            // Create button
            const button = document.createElement('button');
            button.className = isActive ? 'btn btn-danger btn-sm btn-sm-custom' : 'btn btn-success btn-sm btn-sm-custom';
            button.innerHTML = `<i class="fas fa-${isActive ? 'ban' : 'check'}"></i> ${isActive ? 'Deactivate' : 'Activate'}`;
            button.addEventListener('click', function() {
                showToggleModal(staffId, staffName, isActive);
            });
            statusDiv.appendChild(button);
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Initialize password validation for dynamically loaded forms
        function initializePasswordValidation() {
            const newPasswordInput = document.querySelector('#newPassword');
            const confirmPasswordInput = document.querySelector('#confirmPassword');
            const confirmPasswordError = document.querySelector('#confirmPasswordError');

            if (!newPasswordInput || !confirmPasswordInput) return;

            function validatePasswordMatch() {
                const password = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // If new password is entered, confirm password is required and must match
                if (password && confirmPassword) {
                    if (password !== confirmPassword) {
                        if (confirmPasswordError) {
                            confirmPasswordError.textContent = 'Passwords do not match. Please ensure both passwords are identical.';
                            confirmPasswordError.style.display = 'block';
                        }
                        confirmPasswordInput.classList.add('is-invalid');
                        confirmPasswordInput.classList.remove('is-valid');
                        newPasswordInput.classList.add('is-invalid');
                        return false;
                    } else {
                        if (confirmPasswordError) {
                            confirmPasswordError.style.display = 'none';
                        }
                        confirmPasswordInput.classList.remove('is-invalid');
                        confirmPasswordInput.classList.add('is-valid');
                        newPasswordInput.classList.remove('is-invalid');
                        newPasswordInput.classList.add('is-valid');
                        return true;
                    }
                } else if (password && !confirmPassword) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Please confirm your password. Both fields must match.';
                        confirmPasswordError.style.display = 'block';
                    }
                    confirmPasswordInput.classList.add('is-invalid');
                    confirmPasswordInput.classList.remove('is-valid');
                    return false;
                } else if (!password && confirmPassword) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Please enter a new password first before confirming.';
                        confirmPasswordError.style.display = 'block';
                    }
                    confirmPasswordInput.classList.add('is-invalid');
                    confirmPasswordInput.classList.remove('is-valid');
                    return false;
                } else {
                    // Both fields are empty - this is allowed (password change is optional)
                    if (confirmPasswordError) {
                        confirmPasswordError.style.display = 'none';
                    }
                    confirmPasswordInput.classList.remove('is-invalid', 'is-valid');
                    newPasswordInput.classList.remove('is-invalid', 'is-valid');
                    return true;
                }
            }

            newPasswordInput.addEventListener('input', validatePasswordMatch);
            confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            confirmPasswordInput.addEventListener('blur', validatePasswordMatch);

            // Form submission validation
            const form = document.querySelector('.staff-edit-form');
            if (form) {
                const originalSubmit = form.onsubmit;
                form.addEventListener('submit', function(e) {
                    if (!validatePasswordMatch()) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
        }

        // Initialize phone number validation
        function initializePhoneValidation() {
            const phoneInput = document.querySelector('#PhoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function() {
                    const value = this.value;
                    // Remove any non-digit characters
                    this.value = value.replace(/\D/g, '');

                    // Limit to 11 digits
                    if (this.value.length > 11) {
                        this.value = this.value.slice(0, 11);
                    }
                });
            }
        }

        // Initialize input touched state
        function initializeInputTouched() {
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('touched');
                    }
                });

                input.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('touched');
                    }
                });
            });
        }

    </script>
}